import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import io

# -----------------------------------------------------
# НАСТРОЙКА 
# -----------------------------------------------------
st.set_page_config(page_title="CTR // Данные", layout="wide")

# -----------------------------------------------------
# ЭКРАН АВТОРИЗАЦИИ
# -----------------------------------------------------
if "auth_ok" not in st.session_state:
    st.session_state.auth_ok = False

if not st.session_state.auth_ok:
    st.markdown(
        """
        <div style="text-align:center;margin-top:4rem;">
            <h2>Доступ</h2>
            <p style="color:#9ca3af;">Введите пароль, чтобы продолжить</p>
        </div>
        """,
        unsafe_allow_html=True,
    )
    pwd = st.text_input("Пароль", type="password", label_visibility="collapsed")
    if pwd == "SportsTeam":
        st.session_state.auth_ok = True
        st.rerun()
    st.stop()

# -----------------------------------------------------
# ДАННЫЕ (из «Новая таблица 10»)
# -----------------------------------------------------
CTR_DATA = [
    {"День": "2025-04-23", "Просмотры": 265237, "CTR": 0.0054},
    {"День": "2025-04-24", "Просмотры": 426884, "CTR": 0.0051},
    {"День": "2025-04-25", "Просмотры": 413081, "CTR": 0.0049},
    {"День": "2025-04-26", "Просмотры": 481718, "CTR": 0.0069},
    {"День": "2025-04-27", "Просмотры": 623013, "CTR": 0.0064},
    {"День": "2025-04-28", "Просмотры": 472590, "CTR": 0.0050},
    {"День": "2025-04-29", "Просмотры": 500183, "CTR": 0.0048},
    {"День": "2025-04-30", "Просмотры": 517238, "CTR": 0.0042},
    {"День": "2025-05-01", "Просмотры": 244971, "CTR": 0.0036},
    {"День": "2025-05-02", "Просмотры": 371701, "CTR": 0.0038},
    {"День": "2025-05-03", "Просмотры": 437894, "CTR": 0.0029},
    {"День": "2025-05-04", "Просмотры": 561845, "CTR": 0.0049},
    {"День": "2025-05-05", "Просмотры": 476233, "CTR": 0.0034},
    {"День": "2025-05-06", "Просмотры": 471161, "CTR": 0.0037},
    {"День": "2025-05-07", "Просмотры": 471216, "CTR": 0.0040},
    {"День": "2025-05-08", "Просмотры": 485460, "CTR": 0.0037},
    {"День": "2025-05-09", "Просмотры": 422336, "CTR": 0.0030},
    {"День": "2025-05-10", "Просмотры": 454709, "CTR": 0.0039},
    {"День": "2025-05-11", "Просмотры": 558409, "CTR": 0.0037},
    {"День": "2025-05-12", "Просмотры": 565616, "CTR": 0.0034},
    {"День": "2025-05-13", "Просмотры": 547357, "CTR": 0.0030},
    {"День": "2025-05-14", "Просмотры": 526545, "CTR": 0.0033},
    {"День": "2025-05-15", "Просмотры": 535184, "CTR": 0.0038},
    {"День": "2025-05-16", "Просмотры": 516963, "CTR": 0.0031},
    {"День": "2025-05-17", "Просмотры": 500540, "CTR": 0.0037},
    {"День": "2025-05-18", "Просмотры": 462166, "CTR": 0.0049},
    {"День": "2025-05-19", "Просмотры": 538880, "CTR": 0.0037},
    {"День": "2025-05-20", "Просмотры": 541629, "CTR": 0.0036},
    {"День": "2025-05-21", "Просмотры": 527592, "CTR": 0.0035},
    {"День": "2025-05-22", "Просмотры": 460450, "CTR": 0.0035},
    {"День": "2025-05-23", "Просмотры": 467756, "CTR": 0.0031},
    {"День": "2025-05-24", "Просмотры": 534840, "CTR": 0.0035},
    {"День": "2025-05-25", "Просмотры": 506351, "CTR": 0.0035},
    {"День": "2025-05-26", "Просмотры": 522780, "CTR": 0.0030},
    {"День": "2025-05-27", "Просмотры": 478067, "CTR": 0.0033},
    {"День": "2025-05-28", "Просмотры": 509517, "CTR": 0.0031},
    {"День": "2025-05-29", "Просмотры": 531466, "CTR": 0.0034},
    {"День": "2025-05-30", "Просмотры": 524913, "CTR": 0.0029},
    {"День": "2025-05-31", "Просмотры": 462039, "CTR": 0.0040},
    {"День": "2025-06-01", "Просмотры": 465341, "CTR": 0.0044},
    {"День": "2025-06-02", "Просмотры": 535146, "CTR": 0.0033},
    {"День": "2025-06-03", "Просмотры": 560600, "CTR": 0.0035},
    {"День": "2025-06-04", "Просмотры": 559671, "CTR": 0.0031},
    {"День": "2025-06-05", "Просмотры": 575665, "CTR": 0.0031},
    {"День": "2025-06-06", "Просмотры": 561396, "CTR": 0.0034},
    {"День": "2025-06-07", "Просмотры": 465010, "CTR": 0.0046},
    {"День": "2025-06-08", "Просмотры": 508173, "CTR": 0.0041},
    {"День": "2025-06-09", "Просмотры": 567428, "CTR": 0.0034},
    {"День": "2025-06-10", "Просмотры": 531868, "CTR": 0.0031},
    {"День": "2025-06-11", "Просмотры": 523310, "CTR": 0.0034},
    {"День": "2025-06-12", "Просмотры": 469664, "CTR": 0.0042},
    {"День": "2025-06-13", "Просмотры": 502609, "CTR": 0.0034},
    {"День": "2025-06-14", "Просмотры": 472580, "CTR": 0.0044},
    {"День": "2025-06-15", "Просмотры": 525757, "CTR": 0.0043},
    {"День": "2025-06-16", "Просмотры": 591741, "CTR": 0.0034},
    {"День": "2025-06-17", "Просмотры": 558300, "CTR": 0.0030},
    {"День": "2025-06-18", "Просмотры": 619877, "CTR": 0.0027},
    {"День": "2025-06-19", "Просмотры": 504746, "CTR": 0.0029},
    {"День": "2025-06-20", "Просмотры": 507177, "CTR": 0.0031},
    {"День": "2025-06-21", "Просмотры": 529465, "CTR": 0.0038},
    {"День": "2025-06-22", "Просмотры": 557972, "CTR": 0.0036},
    {"День": "2025-06-23", "Просмотры": 720505, "CTR": 0.0029},
    {"День": "2025-06-24", "Просмотры": 557098, "CTR": 0.0030},
    {"День": "2025-06-25", "Просмотры": 553033, "CTR": 0.0031},
    {"День": "2025-06-26", "Просмотры": 542082, "CTR": 0.0029},
    {"День": "2025-06-27", "Просмотры": 555067, "CTR": 0.0028},
    {"День": "2025-06-28", "Просмотры": 541955, "CTR": 0.0037},
    {"День": "2025-06-29", "Просмотры": 559450, "CTR": 0.0035},
    {"День": "2025-06-30", "Просмотры": 571918, "CTR": 0.0028},
    {"День": "2025-07-01", "Просмотры": 542226, "CTR": 0.0033},
    {"День": "2025-07-02", "Просмотры": 550525, "CTR": 0.0031},
    {"День": "2025-07-03", "Просмотры": 538977, "CTR": 0.0034},
    {"День": "2025-07-04", "Просмотры": 559607, "CTR": 0.0031},
    {"День": "2025-07-05", "Просмотры": 546075, "CTR": 0.0037},
    {"День": "2025-07-06", "Просмотры": 556872, "CTR": 0.0035},
    {"День": "2025-07-07", "Просмотры": 559247, "CTR": 0.0033},
    {"День": "2025-07-08", "Просмотры": 550701, "CTR": 0.0030},
    {"День": "2025-07-09", "Просмотры": 546590, "CTR": 0.0031},
    {"День": "2025-07-10", "Просмотры": 538504, "CTR": 0.0031},
    {"День": "2025-07-11", "Просмотры": 547488, "CTR": 0.0032},
    {"День": "2025-07-12", "Просмотры": 518794, "CTR": 0.0036},
    {"День": "2025-07-13", "Просмотры": 532777, "CTR": 0.0033},
    {"День": "2025-07-14", "Просмотры": 566576, "CTR": 0.0033},
    {"День": "2025-07-15", "Просмотры": 553796, "CTR": 0.0030},
    {"День": "2025-07-16", "Просмотры": 551008, "CTR": 0.0030},
    {"День": "2025-07-17", "Просмотры": 557916, "CTR": 0.0031},
    {"День": "2025-07-18", "Просмотры": 543210, "CTR": 0.0032},
    {"День": "2025-07-19", "Просмотры": 534881, "CTR": 0.0037},
    {"День": "2025-07-20", "Просмотры": 560954, "CTR": 0.0033},
    {"День": "2025-07-21", "Просмотры": 565443, "CTR": 0.0032},
    {"День": "2025-07-22", "Просмотры": 560722, "CTR": 0.0030},
    {"День": "2025-07-23", "Просмотры": 547406, "CTR": 0.0032},
    {"День": "2025-07-24", "Просмотры": 579756, "CTR": 0.0032},
    {"День": "2025-07-25", "Просмотры": 546727, "CTR": 0.0033},
    {"День": "2025-07-26", "Просмотры": 545462, "CTR": 0.0033},
    {"День": "2025-07-27", "Просмотры": 577077, "CTR": 0.0034},
    {"День": "2025-07-28", "Просмотры": 580362, "CTR": 0.0032},
    {"День": "2025-07-29", "Просмотры": 588064, "CTR": 0.0031},
    {"День": "2025-07-30", "Просмотры": 581064, "CTR": 0.0031},
    {"День": "2025-07-31", "Просмотры": 544739, "CTR": 0.0035},
    {"День": "2025-08-01", "Просмотры": 520185, "CTR": 0.0035},
    {"День": "2025-08-02", "Просмотры": 501907, "CTR": 0.0039},
    {"День": "2025-08-03", "Просмотры": 482822, "CTR": 0.0040},
    {"День": "2025-08-04", "Просмотры": 669837, "CTR": 0.0025},
    {"День": "2025-08-05", "Просмотры": 576567, "CTR": 0.0027},
    {"День": "2025-08-06", "Просмотры": 642780, "CTR": 0.0028},
    {"День": "2025-08-07", "Просмотры": 673041, "CTR": 0.0029},
    {"День": "2025-08-08", "Просмотры": 566337, "CTR": 0.0026},
    {"День": "2025-08-09", "Просмотры": 576441, "CTR": 0.0032},
    {"День": "2025-08-10", "Просмотры": 535174, "CTR": 0.0035},
    {"День": "2025-08-11", "Просмотры": 652811, "CTR": 0.0028},
    {"День": "2025-08-12", "Просмотры": 581944, "CTR": 0.0030},
    {"День": "2025-08-13", "Просмотры": 574248, "CTR": 0.0027},
    {"День": "2025-08-14", "Просмотры": 571454, "CTR": 0.0025},
    {"День": "2025-08-15", "Просмотры": 609677, "CTR": 0.0026},
    {"День": "2025-08-16", "Просмотры": 553333, "CTR": 0.0034},
    {"День": "2025-08-17", "Просмотры": 543042, "CTR": 0.0033},
    {"День": "2025-08-18", "Просмотры": 593552, "CTR": 0.0030},
    {"День": "2025-08-19", "Просмотры": 604993, "CTR": 0.0029},
    {"День": "2025-08-20", "Просмотры": 585223, "CTR": 0.0029},
    {"День": "2025-08-21", "Просмотры": 565594, "CTR": 0.0031},
    {"День": "2025-08-22", "Просмотры": 561710, "CTR": 0.0031},
    {"День": "2025-08-23", "Просмотры": 573074, "CTR": 0.0034},
    {"День": "2025-08-24", "Просмотры": 576296, "CTR": 0.0036},
    {"День": "2025-08-25", "Просмотры": 639742, "CTR": 0.0030},
    {"День": "2025-08-26", "Просмотры": 628276, "CTR": 0.0028},
    {"День": "2025-08-27", "Просмотры": 682482, "CTR": 0.0038},
    {"День": "2025-08-28", "Просмотры": 634092, "CTR": 0.0030},
    {"День": "2025-08-29", "Просмотры": 649224, "CTR": 0.0028},
    {"День": "2025-08-30", "Просмотры": 618085, "CTR": 0.0030},
    {"День": "2025-08-31", "Просмотры": 587591, "CTR": 0.0031},
    {"День": "2025-09-01", "Просмотры": 716232, "CTR": 0.0028},
    {"День": "2025-09-02", "Просмотры": 639847, "CTR": 0.0029},
    {"День": "2025-09-03", "Просмотры": 662381, "CTR": 0.0027},
    {"День": "2025-09-04", "Просмотры": 634538, "CTR": 0.0029},
    {"День": "2025-09-05", "Просмотры": 630812, "CTR": 0.0027},
    {"День": "2025-09-06", "Просмотры": 599470, "CTR": 0.0031},
    {"День": "2025-09-07", "Просмотры": 631420, "CTR": 0.0033},
    {"День": "2025-09-08", "Просмотры": 682262, "CTR": 0.0027},
    {"День": "2025-09-09", "Просмотры": 657384, "CTR": 0.0028},
    {"День": "2025-09-10", "Просмотры": 636123, "CTR": 0.0026},
    {"День": "2025-09-11", "Просмотры": 648090, "CTR": 0.0027},
    {"День": "2025-09-12", "Просмотры": 609418, "CTR": 0.0029},
    {"День": "2025-09-13", "Просмотры": 617821, "CTR": 0.0035},
    {"День": "2025-09-14", "Просмотры": 617338, "CTR": 0.0033},
    {"День": "2025-09-15", "Просмотры": 672473, "CTR": 0.0029},
    {"День": "2025-09-16", "Просмотры": 679641, "CTR": 0.0027},
    {"День": "2025-09-17", "Просмотры": 633946, "CTR": 0.0029},
    {"День": "2025-09-18", "Просмотры": 656208, "CTR": 0.0027},
    {"День": "2025-09-19", "Просмотры": 654711, "CTR": 0.0028},
    {"День": "2025-09-20", "Просмотры": 637633, "CTR": 0.0033},
    {"День": "2025-09-21", "Просмотры": 642665, "CTR": 0.0031},
    {"День": "2025-09-22", "Просмотры": 669762, "CTR": 0.0027},
    {"День": "2025-09-23", "Просмотры": 660455, "CTR": 0.0030},
    {"День": "2025-09-24", "Просмотры": 672452, "CTR": 0.0027},
    {"День": "2025-09-25", "Просмотры": 660577, "CTR": 0.0027},
    {"День": "2025-09-26", "Просмотры": 679489, "CTR": 0.0026},
    {"День": "2025-09-27", "Просмотры": 653993, "CTR": 0.0031},
    {"День": "2025-09-28", "Просмотры": 635230, "CTR": 0.0033},
    {"День": "2025-09-29", "Просмотры": 696249, "CTR": 0.0026},
    {"День": "2025-09-30", "Просмотры": 652620, "CTR": 0.0026},
    {"День": "2025-10-01", "Просмотры": 652261, "CTR": 0.0026},
    {"День": "2025-10-02", "Просмотры": 663432, "CTR": 0.0026},
    {"День": "2025-10-03", "Просмотры": 642417, "CTR": 0.0028},
    {"День": "2025-10-04", "Просмотры": 538845, "CTR": 0.0036},
    {"День": "2025-10-05", "Просмотры": 564007, "CTR": 0.0035},
    {"День": "2025-10-06", "Просмотры": 691805, "CTR": 0.0025},
    {"День": "2025-10-07", "Просмотры": 636792, "CTR": 0.0026},
    {"День": "2025-10-08", "Просмотры": 641702, "CTR": 0.0027},
    {"День": "2025-10-09", "Просмотры": 658915, "CTR": 0.0026},
    {"День": "2025-10-10", "Просмотры": 611511, "CTR": 0.0028},
    {"День": "2025-10-11", "Просмотры": 623414, "CTR": 0.0032},
    {"День": "2025-10-12", "Просмотры": 614969, "CTR": 0.0031},
    {"День": "2025-10-13", "Просмотры": 656572, "CTR": 0.0027},
    {"День": "2025-10-14", "Просмотры": 652482, "CTR": 0.0026},
    {"День": "2025-10-15", "Просмотры": 651238, "CTR": 0.0025},
    {"День": "2025-10-16", "Просмотры": 643982, "CTR": 0.0027},
    {"День": "2025-10-17", "Просмотры": 615524, "CTR": 0.0029},
    {"День": "2025-10-18", "Просмотры": 632823, "CTR": 0.0030},
    {"День": "2025-10-19", "Просмотры": 643107, "CTR": 0.0029},
    {"День": "2025-10-20", "Просмотры": 638985, "CTR": 0.0028},
    {"День": "2025-10-21", "Просмотры": 614872, "CTR": 0.0025},
    {"День": "2025-10-22", "Просмотры": 610813, "CTR": 0.0026},
    {"День": "2025-10-23", "Просмотры": 687987, "CTR": 0.0027},
    {"День": "2025-10-24", "Просмотры": 603319, "CTR": 0.0024},
    {"День": "2025-10-25", "Просмотры": 0, "CTR": None},
    {"День": "2025-10-26", "Просмотры": 0, "CTR": None},
    {"День": "2025-10-27", "Просмотры": 966724, "CTR": 0.002456},
    {"День": "2025-10-28", "Просмотры": 587150, "CTR": 0.002381},
    {"День": "2025-10-29", "Просмотры": 316702, "CTR": 0.003499},
]
df_ctr = pd.DataFrame(CTR_DATA)
df_ctr["День"] = pd.to_datetime(df_ctr["День"])
df_ctr = df_ctr.sort_values("День").reset_index(drop=True)

# -----------------------------------------------------
# ТРАФИК "В РАЗДЕЛЕ"
# -----------------------------------------------------
TRAFFIC_SECTION_CSV = """Период,Просмотры
2025-04-22,1254
2025-04-23,1161
2025-04-24,1395
2025-04-25,1376
2025-04-26,1136
2025-04-27,940
2025-04-28,1350
2025-04-29,1026
2025-04-30,1175
2025-05-01,1421
2025-05-02,2410
2025-05-03,1844
2025-05-04,1046
2025-05-05,1794
2025-05-06,1630
2025-05-07,1352
2025-05-08,1462
2025-05-09,1352
2025-05-10,1504
2025-05-11,1541
2025-05-12,1928
2025-05-13,1468
2025-05-14,1292
2025-05-15,1481
2025-05-16,1105
2025-05-17,1102
2025-05-18,1168
2025-05-19,1092
2025-05-20,1305
2025-05-21,956
2025-05-22,1101
2025-05-23,929
2025-05-24,1034
2025-05-25,872
2025-05-26,1246
2025-05-27,1078
2025-05-28,891
2025-05-29,1434
2025-05-30,1220
2025-05-31,1123
2025-06-01,995
2025-06-02,2514
2025-06-03,2023
2025-06-04,1367
2025-06-05,1189
2025-06-06,986
2025-06-07,1043
2025-06-08,1103
2025-06-09,2258
2025-06-10,1493
2025-06-11,1589
2025-06-12,1238
2025-06-13,1264
2025-06-14,617
2025-06-15,656
2025-06-16,810
2025-06-17,992
2025-06-18,707
2025-06-19,832
2025-06-20,841
2025-06-21,764
2025-06-22,743
2025-06-23,867
2025-06-24,807
2025-06-25,708
2025-06-26,762
2025-06-27,761
2025-06-28,713
2025-06-29,711
2025-06-30,830
2025-07-01,968
2025-07-02,1474
2025-07-03,1856
2025-07-04,1346
2025-07-05,1358
2025-07-06,1239
2025-07-07,1299
2025-07-08,1083
2025-07-09,1015
2025-07-10,1164
2025-07-11,1021
2025-07-12,1062
2025-07-13,1161
2025-07-14,1254
2025-07-15,1318
2025-07-16,1262
2025-07-17,1232
2025-07-18,1037
2025-07-19,838
2025-07-20,882
2025-07-21,956
2025-07-22,929
2025-07-23,977
2025-07-24,995
2025-07-25,942
2025-07-26,879
2025-07-27,784
2025-07-28,871
2025-07-29,885
2025-07-30,960
2025-07-31,892
2025-08-01,988
2025-08-02,841
2025-08-03,866
2025-08-04,1821
2025-08-05,2067
2025-08-06,1333
2025-08-07,1013
2025-08-08,931
2025-08-09,796
2025-08-10,825
2025-08-11,990
2025-08-12,938
2025-08-13,969
2025-08-14,1004
2025-08-15,930
2025-08-16,884
2025-08-17,874
2025-08-18,1042
2025-08-19,968
2025-08-20,870
2025-08-21,958
2025-08-22,944
2025-08-23,903
2025-08-24,862
2025-08-25,933
2025-08-26,935
2025-08-27,882
2025-08-28,925
2025-08-29,910
2025-08-30,809
2025-08-31,958
2025-09-01,1192
2025-09-02,1027
2025-09-03,1117
2025-09-04,1047
2025-09-05,905
2025-09-06,901
2025-09-07,889
2025-09-08,965
2025-09-09,836
2025-09-10,964
2025-09-11,874
2025-09-12,812
2025-09-13,823
2025-09-14,884
2025-09-15,843
2025-09-16,1008
2025-09-17,979
2025-09-18,961
2025-09-19,1044
2025-09-20,888
2025-09-21,948
2025-09-22,1016
2025-09-23,996
2025-09-24,1075
2025-09-25,1093
2025-09-26,1036
2025-09-27,839
2025-09-28,803
2025-09-29,936
2025-09-30,914
2025-10-01,999
2025-10-02,976
2025-10-03,802
2025-10-04,759
2025-10-05,865
2025-10-06,836
2025-10-07,807
2025-10-08,931
2025-10-09,874
2025-10-10,812
2025-10-11,786
2025-10-12,833
2025-10-13,867
2025-10-14,969
2025-10-15,917
2025-10-16,843
2025-10-17,907
2025-10-18,810
2025-10-19,849
2025-10-20,891
2025-10-21,834
2025-10-22,693
2025-10-23,730
2025-10-24,603
2025-10-25,541
2025-10-26,636
2025-10-27,488
2025-10-28,639
2025-10-29,570
2025-10-30,624
"""
df_section = pd.read_csv(io.StringIO(TRAFFIC_SECTION_CSV))
df_section["Период"] = pd.to_datetime(df_section["Период"])
df_section = df_section.sort_values("Период").reset_index(drop=True)

# -----------------------------------------------------
# СПОРТСОБЫТИЯ
# -----------------------------------------------------
EVENTS = [
    {"начало": "2025-03-26", "окончание": "2025-05-25", "название": "Плей-офф КХЛ", "вид спорта": "Хоккей"},
    {"начало": "2025-04-15", "окончание": "2025-06-22", "название": "Плей-офф НБА", "вид спорта": "Баскетбол"},
    {"начало": "2025-04-19", "окончание": "2025-06-23", "название": "Плей-офф НХЛ", "вид спорта": "Хоккей"},
    {"начало": "2025-04-26", "окончание": "2025-04-26", "название": "Эль Классико (апрель)", "вид спорта": "Футбол"},
    {"начало": "2025-05-09", "окончание": "2025-05-25", "название": "Чемпионат мира по хоккею", "вид спорта": "Хоккей"},
    {"начало": "2025-05-11", "окончание": "2025-05-11", "название": "Эль Классико (май)", "вид спорта": "Футбол"},
    {"начало": "2025-05-24", "окончание": "2025-05-24", "название": "Заключительный тур РПЛ", "вид спорта": "Футбол"},
    {"начало": "2025-05-25", "окончание": "2025-06-07", "название": "Теннис «Ролан Гаррос»", "вид спорта": "Теннис"},
    {"начало": "2025-05-31", "окончание": "2025-05-31", "название": "Финал Лиги чемпионов", "вид спорта": "Футбол"},
    {"начало": "2025-06-14", "окончание": "2025-07-13", "название": "Клубный чемпионат мира", "вид спорта": "Футбол"},
    {"начало": "2025-06-29", "окончание": "2025-06-29", "название": "UFC 317", "вид спорта": "UFC"},
    {"начало": "2025-06-30", "окончание": "2025-07-13", "название": "Теннис «Уимблдон»", "вид спорта": "Теннис"},
    {"начало": "2025-07-18", "окончание": "2025-10-29", "название": "Старт сезона РПЛ", "вид спорта": "Футбол"},
    {"начало": "2025-08-02", "окончание": "2025-10-29", "название": "Старт сезона АПЛ", "вид спорта": "Футбол"},
    {"начало": "2025-08-15", "окончание": "2025-10-29", "название": "Старт сезона Ла Лиги", "вид спорта": "Футбол"},
    {"начало": "2025-08-17", "окончание": "2025-08-17", "название": "UFC 319", "вид спорта": "UFC"},
    {"начало": "2025-08-25", "окончание": "2025-09-07", "название": "Теннис US Open", "вид спорта": "Теннис"},
    {"начало": "2025-08-27", "окончание": "2025-09-14", "название": "Баскетбол Евро-2025 (М)", "вид спорта": "Баскетбол"},
    {"начало": "2025-10-04", "окончание": "2025-10-04", "название": "UFC 320", "вид спорта": "UFC"},
    {"начало": "2025-10-07", "окончание": "2025-10-29", "название": "Старт сезона НХЛ", "вид спорта": "Хоккей"},
    {"начало": "2025-10-21", "окончание": "2025-10-29", "название": "Старт сезона НБА", "вид спорта": "Баскетбол"},
    {"начало": "2025-10-26", "окончание": "2025-10-26", "название": "Эль Классико (октябрь)", "вид спорта": "Футбол"},
]
df_events = pd.DataFrame(EVENTS)
df_events["начало"] = pd.to_datetime(df_events["начало"])
df_events["окончание"] = pd.to_datetime(df_events["окончание"])

# -----------------------------------------------------
# ДАННЫЕ «ДРУГИЕ РК» — СЕРИЯ «Ф»
# (проценты приведены к долям: 0,23% -> 0.0023)
# -----------------------------------------------------
SERIES_F_RAW = [
    ("2025-07-15","0,23 %"),("2025-07-16","0,21 %"),("2025-07-17","0,21 %"),("2025-07-18","0,26 %"),
    ("2025-07-19","0,31 %"),("2025-07-20","0,32 %"),("2025-07-21","0,21 %"),("2025-07-22","0,18 %"),
    ("2025-07-24","0,23 %"),("2025-07-25","0,27 %"),("2025-07-26","0,30 %"),("2025-07-27","0,27 %"),
    ("2025-07-28","0,22 %"),("2025-07-29","0,24 %"),("2025-07-30","0,23 %"),("2025-07-31","0,20 %"),
    ("2025-08-01","0,21 %"),("2025-08-02","0,27 %"),("2025-08-03","0,24 %"),("2025-08-04","0,18 %"),
    ("2025-08-05","0,20 %"),("2025-08-06","0,18 %"),("2025-08-07","0,18 %"),("2025-08-08","0,18 %"),
    ("2025-08-09","0,25 %"),("2025-08-10","0,25 %"),("2025-08-11",""),("2025-08-12","0,22 %"),
    ("2025-08-13","0,21 %"),("2025-08-14","0,21 %"),("2025-08-15","0,19 %"),("2025-08-16","0,24 %"),
    ("2025-08-17","0,24 %"),("2025-08-18","0,17 %"),("2025-08-19","0,19 %"),("2025-08-20","0,19 %"),
    ("2025-08-21","0,15 %"),("2025-08-22","0,14 %"),("2025-08-23","0,20 %"),("2025-08-24","0,20 %"),
    ("2025-08-25","0,15 %"),("2025-08-26","0,18 %"),("2025-08-27","0,22 %"),("2025-08-28","0,29 %"),
    ("2025-08-29","0,25 %"),("2025-08-30","0,29 %"),("2025-08-31","0,29 %"),("2025-09-01","0,21 %"),
    ("2025-09-02","0,24 %"),("2025-09-03","0,21 %"),("2025-09-04","0,24 %"),("2025-09-05","0,25 %"),
    ("2025-09-06","0,29 %"),("2025-09-07","0,26 %"),("2025-09-08","0,23 %"),("2025-09-09","0,22 %"),
    ("2025-09-10","0,19 %"),("2025-09-11","0,18 %"),("2025-09-12","0,15 %"),("2025-09-13","0,11 %"),
    ("2025-09-14","0,12 %"),("2025-09-15","0,10 %"),("2025-09-16","0,11 %"),("2025-09-17","0,14 %"),
    ("2025-09-18","0,10 %"),("2025-09-19","0,11 %"),("2025-09-20","0,14 %"),("2025-09-21","0,16 %"),
    ("2025-09-22","0,16 %"),("2025-09-23","0,00 %"),("2025-09-24","0,24 %"),("2025-09-25","0,19 %"),
    ("2025-09-26","0,27 %"),("2025-09-27","0,39 %"),("2025-09-28","0,38 %"),("2025-09-29","0,25 %"),
    ("2025-09-30","0,59 %"),("2025-10-01","0,26 %"),("2025-10-02","0,18 %"),("2025-10-03","0,17 %"),
    ("2025-10-04","0,25 %"),("2025-10-05","0,27 %"),("2025-10-06","0,17 %"),
]

def _pct_str_to_float(x: str) -> float:
    # "0,23 %" -> 0.0023
    x = x.replace("%", "").replace("\xa0", "").replace(" ", "").replace(",", ".")
    try:
        return float(x) / 100.0
    except Exception:
        return None

df_F = pd.DataFrame(SERIES_F_RAW, columns=["День", "CTR"])
df_F["День"] = pd.to_datetime(df_F["День"])
df_F["CTR"] = df_F["CTR"].apply(_pct_str_to_float)
df_F = df_F.dropna().sort_values("День").reset_index(drop=True)

# --- Новая серия «ТГ-Ф» (проценты -> доли) ---
SERIES_TG_F_RAW = [
    ("2025-08-18","0,26 %"),
    ("2025-08-19","0,26 %"),
    ("2025-08-20","0,24 %"),
    ("2025-08-21","0,23 %"),
    ("2025-08-22","0,21 %"),
    ("2025-08-23","0,32 %"),
    ("2025-08-24","0,32 %"),
    ("2025-08-25","0,23 %"),
    ("2025-08-26","0,23 %"),
    ("2025-08-27","0,26 %"),
    ("2025-08-28","0,28 %"),
    ("2025-08-29","0,29 %"),
    ("2025-08-30","0,34 %"),
    ("2025-08-31","0,33 %"),
    ("2025-09-01","0,26 %"),
    ("2025-09-02","0,25 %"),
    ("2025-09-03","0,27 %"),
    ("2025-09-04","0,28 %"),
    ("2025-09-05","0,35 %"),
    ("2025-09-06","0,38 %"),
    ("2025-09-07","0,36 %"),
    ("2025-09-08","0,28 %"),
    ("2025-09-09","0,28 %"),
    ("2025-09-10","0,24 %"),
    ("2025-09-11","0,22 %"),
    ("2025-09-12","0,30 %"),
    ("2025-09-13","0,29 %"),
    ("2025-09-14","0,30 %"),
    ("2025-09-15","0,25 %"),
    ("2025-09-16","0,22 %"),
    ("2025-09-17","0,21 %"),
    ("2025-09-18","0,21 %"),
    ("2025-09-19","0,26 %"),
    ("2025-09-20","0,33 %"),
    ("2025-09-21","0,30 %"),
    ("2025-09-22","0,26 %"),
    ("2025-09-23","0,23 %"),
    ("2025-09-24","0,22 %"),
    ("2025-09-25","0,24 %"),
    ("2025-09-26","0,24 %"),
    ("2025-09-27","0,25 %"),
    ("2025-09-28","0,27 %"),
    ("2025-09-29","0,20 %"),
    ("2025-09-30","0,30 %"),
    ("2025-10-01","0,25 %"),
]
df_TG_F = pd.DataFrame(SERIES_TG_F_RAW, columns=["День", "CTR"])
df_TG_F["День"] = pd.to_datetime(df_TG_F["День"])
df_TG_F["CTR"] = df_TG_F["CTR"].apply(_pct_str_to_float)
df_TG_F = df_TG_F.dropna().sort_values("День").reset_index(drop=True)
# -----------------------------------------------------
# ОБЩИЙ ТРАФИК: три серии (Н, В, О) + будем накладывать CTR
# -----------------------------------------------------
RAW_N = """
2025-04-22 394075 2025-04-23 431960 2025-04-24 392268 2025-04-25 392847 2025-04-26 490695
2025-04-27 490031 2025-04-28 399954 2025-04-29 453505 2025-04-30 492720 2025-05-01 423915
2025-05-02 406675 2025-05-03 426429 2025-05-04 470862 2025-05-05 419772 2025-05-06 524805
2025-05-07 536817 2025-05-08 399599 2025-05-09 340019 2025-05-10 431107 2025-05-11 578459
2025-05-12 479299 2025-05-13 463256 2025-05-14 460133 2025-05-15 487988 2025-05-16 415406
2025-05-17 437822 2025-05-18 476978 2025-05-19 459161 2025-05-20 421747 2025-05-21 416904
2025-05-22 391203 2025-05-23 365991 2025-05-24 444969 2025-05-25 431732 2025-05-26 390172
2025-05-27 371883 2025-05-28 452891 2025-05-29 442131 2025-05-30 430203 2025-05-31 681442
2025-06-01 475002 2025-06-02 407452 2025-06-03 409448 2025-06-04 424698 2025-06-05 468818
2025-06-06 386015 2025-06-07 340440 2025-06-08 449203 2025-06-09 405179 2025-06-10 382678
2025-06-11 351891 2025-06-12 321021 2025-06-13 309622 2025-06-14 299744 2025-06-15 334259
2025-06-16 331446 2025-06-17 352779 2025-06-18 393352 2025-06-19 370402 2025-06-20 376817
2025-06-21 335677 2025-06-22 321276 2025-06-23 315020 2025-06-24 291553 2025-06-25 282679
2025-06-26 288607 2025-06-27 277290 2025-06-28 268855 2025-06-29 335783 2025-06-30 298646
2025-07-01 337396 2025-07-02 302992 2025-07-03 321254 2025-07-04 283200 2025-07-05 332812
2025-07-06 305480 2025-07-07 306819 2025-07-08 328955 2025-07-09 368103 2025-07-10 316181
2025-07-11 287758 2025-07-12 273847 2025-07-13 356306 2025-07-14 315901 2025-07-15 282113
2025-07-16 274885 2025-07-17 286183 2025-07-18 298201 2025-07-19 290650 2025-07-20 326211
2025-07-21 291091 2025-07-22 269273 2025-07-23 273120 2025-07-24 271656 2025-07-25 273384
2025-07-26 300389 2025-07-27 323517 2025-07-28 284296 2025-07-29 271159 2025-07-30 301468
2025-07-31 284488 2025-08-01 267544 2025-08-02 269041 2025-08-03 305118 2025-08-04 299547
2025-08-05 300411 2025-08-06 292744 2025-08-07 296038 2025-08-08 293095 2025-08-09 278004
2025-08-10 288019 2025-08-11 296958 2025-08-12 283535 2025-08-13 291728 2025-08-14 287581
2025-08-15 292216 2025-08-16 294619 2025-08-17 330438 2025-08-18 305687 2025-08-19 268311
2025-08-20 282697 2025-08-21 279828 2025-08-22 286968 2025-08-23 330639 2025-08-24 318792
2025-08-25 321116 2025-08-26 315577 2025-08-27 352453 2025-08-28 387921 2025-08-29 353572
2025-08-30 348207 2025-08-31 374940 2025-09-01 350983 2025-09-02 327660 2025-09-03 338404
2025-09-04 362778 2025-09-05 340001 2025-09-06 344350 2025-09-07 355185 2025-09-08 346985
2025-09-09 328557 2025-09-10 317233 2025-09-11 321668 2025-09-12 335116 2025-09-13 368588
2025-09-14 418421 2025-09-15 377925 2025-09-16 396417 2025-09-17 403287 2025-09-18 429962
2025-09-19 412814 2025-09-20 458937 2025-09-21 467846 2025-09-22 474260 2025-09-23 429236
2025-09-24 390122 2025-09-25 374962 2025-09-26 374869 2025-09-27 413564 2025-09-28 413453
2025-09-29 395441 2025-09-30 802236 2025-10-01 491284 2025-10-02 389676 2025-10-03 348391
2025-10-04 368081 2025-10-05 436485 2025-10-06 374181 2025-10-07 362733 2025-10-08 363178
2025-10-09 356601 2025-10-10 417375 2025-10-11 516885 2025-10-12 503617 2025-10-13 516846
2025-10-14 385345 2025-10-15 333074 2025-10-16 310718 2025-10-17 318658 2025-10-18 390307
2025-10-19 437694 2025-10-20 450315 2025-10-21 453869 2025-10-22 391040 2025-10-23 329048
2025-10-24 406165 2025-10-25 491058 2025-10-26 827517 2025-10-27 341193 2025-10-28 353682
2025-10-29 394154 2025-10-30 418535 2025-10-31 428566 2025-11-01 443047 2025-11-02 495865
2025-11-03 483407 2025-11-04 574516 2025-11-05 568606 2025-11-06 363951
""".strip()

RAW_V = """
2025-04-22 2519556 2025-04-23 2572755 2025-04-24 2481839 2025-04-25 2540521 2025-04-26 2903699
2025-04-27 3255443 2025-04-28 2664476 2025-04-29 2561038 2025-04-30 2725070 2025-05-01 2766969
2025-05-02 2571592 2025-05-03 2688022 2025-05-04 3133262 2025-05-05 2804448 2025-05-06 2714472
2025-05-07 2938000 2025-05-08 2318866 2025-05-09 2210697 2025-05-10 2754690 2025-05-11 3399303
2025-05-12 2898209 2025-05-13 2845120 2025-05-14 2766563 2025-05-15 2813019 2025-05-16 2553276
2025-05-17 2665818 2025-05-18 3039431 2025-05-19 2843407 2025-05-20 2437519 2025-05-21 2446965
2025-05-22 2555242 2025-05-23 2412201 2025-05-24 3146448 2025-05-25 2891453 2025-05-26 2584561
2025-05-27 2327277 2025-05-28 2414084 2025-05-29 2534134 2025-05-30 2414102 2025-05-31 2511781
2025-06-01 2866818 2025-06-02 2537186 2025-06-03 2377112 2025-06-04 2372501 2025-06-05 2493591
2025-06-06 2261557 2025-06-07 2071426 2025-06-08 2239493 2025-06-09 2445476 2025-06-10 2237951
2025-06-11 1977527 2025-06-12 1724631 2025-06-13 1634657 2025-06-14 1577580 2025-06-15 1877447
2025-06-16 1961840 2025-06-17 1942106 2025-06-18 2055803 2025-06-19 1996369 2025-06-20 2055513
2025-06-21 1810231 2025-06-22 1837116 2025-06-23 1928291 2025-06-24 1800638 2025-06-25 1792270
2025-06-26 1787058 2025-06-27 1729217 2025-06-28 1635232 2025-06-29 1951664 2025-06-30 1956056
2025-07-01 2272373 2025-07-02 2047764 2025-07-03 2113445 2025-07-04 1885070 2025-07-05 2107520
2025-07-06 2038518 2025-07-07 2039247 2025-07-08 1902817 2025-07-09 1942884 2025-07-10 1969830
2025-07-11 1741971 2025-07-12 1563871 2025-07-13 1877615 2025-07-14 2059677 2025-07-15 1739587
2025-07-16 1743036 2025-07-17 1782876 2025-07-18 1817832 2025-07-19 1823362 2025-07-20 2128316
2025-07-21 1938497 2025-07-22 1764775 2025-07-23 1733985 2025-07-24 1699978 2025-07-25 1680347
2025-07-26 1872606 2025-07-27 2063294 2025-07-28 1895131 2025-07-29 1811664 2025-07-30 1938829
2025-07-31 1786866 2025-08-01 1728851 2025-08-02 1787918 2025-08-03 2167302 2025-08-04 1959193
2025-08-05 1975460 2025-08-06 1910679 2025-08-07 1864533 2025-08-08 1764792 2025-08-09 1941999
2025-08-10 2059407 2025-08-11 1911655 2025-08-12 1806514 2025-08-13 1824858 2025-08-14 1763583
2025-08-15 1722690 2025-08-16 2042054 2025-08-17 2292045 2025-08-18 1957497 2025-08-19 1668393
2025-08-20 1694373 2025-08-21 1737268 2025-08-22 1896974 2025-08-23 2316138 2025-08-24 2379492
2025-08-25 2163447 2025-08-26 2042656 2025-08-27 2035898 2025-08-28 2164355 2025-08-29 2003689
2025-08-30 2257973 2025-08-31 2680395 2025-09-01 2540220 2025-09-02 2085686 2025-09-03 1926470
2025-09-04 2004514 2025-09-05 2019593 2025-09-06 1869790 2025-09-07 2031873 2025-09-08 2038463
2025-09-09 1844505 2025-09-10 1874781 2025-09-11 1686504 2025-09-12 1733795 2025-09-13 2142142
2025-09-14 2517232 2025-09-15 2076800 2025-09-16 2047067 2025-09-17 2204671 2025-09-18 2191776
2025-09-19 2160125 2025-09-20 2458933 2025-09-21 2679950 2025-09-22 2476035 2025-09-23 2075304
2025-09-24 1961976 2025-09-25 1810053 2025-09-26 1861328 2025-09-27 2520767 2025-09-28 2513786
2025-09-29 2083050 2025-09-30 2240877 2025-10-01 2256479 2025-10-02 1956687 2025-10-03 1760969
2025-10-04 2253426 2025-10-05 2690262 2025-10-06 2031784 2025-10-07 1825030 2025-10-08 1754857
2025-10-09 1839749 2025-10-10 1920645 2025-10-11 1760109 2025-10-12 1973563 2025-10-13 1932534
2025-10-14 1962153 2025-10-15 1883601 2025-10-16 1737751 2025-10-17 1793839 2025-10-18 2403866
2025-10-19 2698184 2025-10-20 2229179 2025-10-21 2079910 2025-10-22 2052255 2025-10-23 1889298
2025-10-24 1793376 2025-10-25 2103669 2025-10-26 2691073 2025-10-27 1849004 2025-10-28 1724939
2025-10-29 1715967 2025-10-30 1703064 2025-10-31 1718162 2025-11-01 1975556 2025-11-02 2105714
2025-11-03 1773762 2025-11-04 1793572 2025-11-05 2109002 2025-11-06 1518508
""".strip()

RAW_O = """
2025-04-22 2915586 2025-04-23 3006702 2025-04-24 2875287 2025-04-25 2935471 2025-04-26 3396767
2025-04-27 3746683 2025-04-28 3066090 2025-04-29 3015338 2025-04-30 3218899 2025-05-01 3207742
2025-05-02 3000226 2025-05-03 3122788 2025-05-04 3610887 2025-05-05 3232548 2025-05-06 3248519
2025-05-07 3481817 2025-05-08 2727226 2025-05-09 2558633 2025-05-10 3192832 2025-05-11 3983134
2025-05-12 3393912 2025-05-13 3322753 2025-05-14 3236805 2025-05-15 3306892 2025-05-16 2972003
2025-05-17 3112277 2025-05-18 3519441 2025-05-19 3305467 2025-05-20 2861195 2025-05-21 2865065
2025-05-22 2947613 2025-05-23 2779276 2025-05-24 3593700 2025-05-25 3326092 2025-05-26 2976858
2025-05-27 2699989 2025-05-28 2867842 2025-05-29 2983844 2025-05-30 2849817 2025-05-31 3198936
2025-06-01 3360318 2025-06-02 2961351 2025-06-03 2800150 2025-06-04 2803623 2025-06-05 2968405
2025-06-06 2655687 2025-06-07 2416872 2025-06-08 2694197 2025-06-09 2859755 2025-06-10 2634308
2025-06-11 2338452 2025-06-12 2053358 2025-06-13 1949621 2025-06-14 1881836 2025-06-15 2216089
2025-06-16 2299556 2025-06-17 2303466 2025-06-18 2451394 2025-06-19 2368698 2025-06-20 2433332
2025-06-21 2147810 2025-06-22 2161162 2025-06-23 2247855 2025-06-24 2094993 2025-06-25 2075716
2025-06-26 2076493 2025-06-27 2008756 2025-06-28 1905348 2025-06-29 2290109 2025-06-30 2257498
2025-07-01 2633176 2025-07-02 2372600 2025-07-03 2450705 2025-07-04 2184076 2025-07-05 2470502
2025-07-06 2369743 2025-07-07 2363387 2025-07-08 2241896 2025-07-09 2319524 2025-07-10 2297083
2025-07-11 2041460 2025-07-12 1853590 2025-07-13 2256864 2025-07-14 2395192 2025-07-15 2038019
2025-07-16 2033837 2025-07-17 2088237 2025-07-18 2128501 2025-07-19 2122116 2025-07-20 2460464
2025-07-21 2239082 2025-07-22 2047696 2025-07-23 2016894 2025-07-24 1983398 2025-07-25 1960391
2025-07-26 2178142 2025-07-27 2389750 2025-07-28 2185753 2025-07-29 2088359 2025-07-30 2245136
2025-07-31 2077206 2025-08-01 2013444 2025-08-02 2072293 2025-08-03 2483377 2025-08-04 2267148
2025-08-05 2284318 2025-08-06 2209250 2025-08-07 2170708 2025-08-08 2065250 2025-08-09 2226441
2025-08-10 2353082 2025-08-11 2215433 2025-08-12 2093288 2025-08-13 2119178 2025-08-14 2055863
2025-08-15 2020153 2025-08-16 2339592 2025-08-17 2625301 2025-08-18 2266431 2025-08-19 1940356
2025-08-20 1979803 2025-08-21 2020696 2025-08-22 2192645 2025-08-23 2651445 2025-08-24 2701245
2025-08-25 2487139 2025-08-26 2362835 2025-08-27 2394170 2025-08-28 2557075 2025-08-29 2361491
2025-08-30 2608117 2025-08-31 3060082 2025-09-01 2905760 2025-09-02 2424010 2025-09-03 2275450
2025-09-04 2378938 2025-09-05 2370398 2025-09-06 2219937 2025-09-07 2395853 2025-09-08 2393678
2025-09-09 2179395 2025-09-10 2198483 2025-09-11 2009615 2025-09-12 2071345 2025-09-13 2512109
2025-09-14 2936668 2025-09-15 2456725 2025-09-16 2445824 2025-09-17 2609149 2025-09-18 2622921
2025-09-19 2576394 2025-09-20 2919035 2025-09-21 3149116 2025-09-22 2952986 2025-09-23 2507343
2025-09-24 2354570 2025-09-25 2187513 2025-09-26 2239958 2025-09-27 2939172 2025-09-28 2928901
2025-09-29 2481967 2025-09-30 3047020 2025-10-01 2753717 2025-10-02 2350778 2025-10-03 2114542
2025-10-04 2624649 2025-10-05 3130093 2025-10-06 2408698 2025-10-07 2192112 2025-10-08 2119853
2025-10-09 2198648 2025-10-10 2340237 2025-10-11 2279199 2025-10-12 2479146 2025-10-13 2452275
2025-10-14 2349680 2025-10-15 2218887 2025-10-16 2050949 2025-10-17 2115883 2025-10-18 2797024
2025-10-19 3138374 2025-10-20 2682911 2025-10-21 2535784 2025-10-22 2444247 2025-10-23 2219579
2025-10-24 2202399 2025-10-25 2596432 2025-10-26 3520262 2025-10-27 2191773 2025-10-28 2079862
2025-10-29 2110897 2025-10-30 2122545 2025-10-31 2148372 2025-11-01 2420231 2025-11-02 2603536
2025-11-03 2259471 2025-11-04 2370372 2025-11-05 2679419 2025-11-06 1500178
""".strip()

def _parse_pairs(raw: str, name: str) -> pd.DataFrame:
    toks = raw.split()
    out = []
    for i in range(0, len(toks), 2):
        d, v = toks[i], toks[i+1]
        out.append({"День": pd.to_datetime(d), name: int(v)})
    return pd.DataFrame(out).sort_values("День").reset_index(drop=True)

df_N = _parse_pairs(RAW_N, "Н")
df_V = _parse_pairs(RAW_V, "В")
df_O = _parse_pairs(RAW_O, "О")


# Возможность добавить до 3 дополнительных серий (теперь две — «Ф» и «ТГ-Ф»)
EXTRA_SERIES = [
    {
        "name": "Ф",
        "df": df_F,
        "style": {"dash": "dot", "width": 2.2, "color": "rgba(255,99,132,1)", "marker_size": 4},
    },
    {
        "name": "ТГ-Ф",
        "df": df_TG_F,
        "style": {"dash": "dash", "width": 2.4, "color": "rgba(155,89,182,1)", "marker_size": 5},
    },
]

# -----------------------------------------------------
# ВИЗУАЛЬНЫЙ СЕЛЕКТОР СТРАНИЦ
# -----------------------------------------------------
with st.container():
    st.markdown(
        """
        <style>
        .page-pill {
            display:inline-block;
            margin-right:0.5rem;
            margin-bottom:0.4rem;
        }
        </style>
        """,
        unsafe_allow_html=True,
    )
    st.markdown(
        "<div style='margin-bottom:0.4rem;font-weight:500;'>Выбор раздела</div>",
        unsafe_allow_html=True,
    )
    page = st.radio(
    "",
    (
        "Итоги",
        "Смена креативов",
        "Спортивные события",
        "Трафик в разделе",
        "Просмотры",
        "Другие РК",
        "Общий трафик",  # <— добавили
    ),
    horizontal=True,
    label_visibility="collapsed",
)

if page == "Итоги":
    # ==============================
    # ИТОГИ: робастные локальные пики CTR (окно ±10 дней)
    # ==============================
    import numpy as np

    st.markdown("### Итоги: локальные пики CTR и факторы (робастный критерий, окно ±10 дней)")

    # --- границы флайтов (как в «Смена креативов») ---
    b1 = pd.to_datetime("2025-04-23")
    b2 = pd.to_datetime("2025-07-07")
    b3 = pd.to_datetime("2025-08-14")
    b4 = pd.to_datetime("2025-10-22")
    b5 = pd.to_datetime("2025-10-29")

    # ---------- Вспомогательные функции ----------
    def month_index_from_anchor(d: pd.Timestamp, anchor=pd.Timestamp("2025-04-22")) -> int:
        shifted = d - pd.Timedelta(days=21)
        anchor_shifted = anchor - pd.Timedelta(days=21)
        return (shifted.year - anchor_shifted.year) * 12 + (shifted.month - anchor_shifted.month) + 1

    def in_active_season(d: pd.Timestamp) -> bool:
        return d.month in (2, 3, 4, 5, 6)

    def creative_number_for_day(d: pd.Timestamp) -> int | None:
        if d < b2: return 1
        elif d < b3: return 2
        elif d < b4: return 3
        elif d <= b5: return 4
        return None

    def creative_change_within_plus5(d: pd.Timestamp) -> bool:
        for cp in (b2, b3, b4):
            if d <= cp <= d + pd.Timedelta(days=5):
                return True
        return False

    def event_exact_titles(d: pd.Timestamp) -> list[str]:
        if df_events is None or df_events.empty:
            return []
        rows = df_events[
            (df_events["начало"].dt.date == d.date()) |
            (df_events["окончание"].dt.date == d.date())
        ]
        return [] if rows.empty else [str(x) for x in rows["название"].tolist()]

    def mad(x: np.ndarray) -> float:
        x = np.asarray(x, dtype=float)
        x = x[~np.isnan(x)]
        if x.size == 0:
            return np.nan
        med = np.median(x)
        return np.median(np.abs(x - med))

    # ---------- Подготовка базовой таблицы дней ----------
    ctr = df_ctr.sort_values("День").reset_index(drop=True).copy()
    base = pd.DataFrame({"День": pd.date_range(ctr["День"].min(), ctr["День"].max(), freq="D")})
    base = base.merge(ctr[["День", "CTR"]], on="День", how="left")

    # Подмешаем «Н», «В», «О» (если уже определены в «Общий трафик»)
    if "df_N" in globals(): base = base.merge(df_N, on="День", how="left")        # колонка "Н"
    if "df_V" in globals(): base = base.merge(df_V, on="День", how="left")        # колонка "В"
    if "df_O" in globals(): base = base.merge(df_O, on="День", how="left")        # колонка "О"
    base = base.sort_values("День").reset_index(drop=True)

    # --- предрасчёт по флайтам
    def flight_slice(dfrom: pd.Timestamp, dto: pd.Timestamp) -> pd.Series:
        m = (base["День"] >= dfrom) & (base["День"] < dto)
        return base.loc[m, "CTR"]

    flight_stats = {
        1: flight_slice(b1, b2),
        2: flight_slice(b2, b3),
        3: flight_slice(b3, b4),
        4: flight_slice(b4, b5 + pd.Timedelta(days=0)),
    }
    flight_meds = {k: np.nanmedian(v.values) if v.size else np.nan for k, v in flight_stats.items()}
    flight_sigmas = {}
    for k, v in flight_stats.items():
        m_ = mad(v.values)
        if np.isnan(m_) or m_ == 0:
            vv = v.values.astype(float); vv = vv[~np.isnan(vv)]
            if vv.size:
                iqr = np.nanpercentile(vv, 75) - np.nanpercentile(vv, 25)
                sigma_rb = iqr / 1.349 if iqr > 0 else np.nan
            else:
                sigma_rb = np.nan
        else:
            sigma_rb = 1.4826 * m_
        flight_sigmas[k] = sigma_rb

    # ---------- Робастный детектор пиков ----------
    W = 10
    z_min = 1.0
    relA0 = 0.04
    relB0 = 0.03
    target_low, target_high = 20, 25
    step = 0.005
    max_iters = 30

    def make_candidates(relA: float, relB: float) -> list[int]:
        cand = []
        vals = base["CTR"].values
        for i in range(len(base)):
            center = vals[i]
            if np.isnan(center): continue
            left = max(0, i - W); right = min(len(base) - 1, i + W)

            win = base["CTR"].iloc[left:right+1].copy()
            win_wo = win.drop(base.index[i], errors="ignore")
            win_vals = win.values.astype(float)
            wo_vals = win_wo.values.astype(float)

            med_win = np.nanmedian(win_vals) if win_vals.size else np.nan
            mad_win = mad(win_vals)
            sigma = 1.4826 * mad_win if (not np.isnan(mad_win) and mad_win != 0) else np.nan
            if (np.isnan(sigma) or sigma == 0) and win_vals.size:
                iqr = np.nanpercentile(win_vals, 75) - np.nanpercentile(win_vals, 25)
                sigma = iqr / 1.349 if iqr > 0 else np.nan

            mean_wo = np.nanmean(wo_vals) if wo_vals.size else np.nan
            rel = (center - mean_wo) / mean_wo if (not np.isnan(mean_wo) and mean_wo > 0) else np.nan
            q85 = np.nanquantile(win_vals, 0.85) if win_vals.size else np.nan
            z = (center - med_win) / sigma if (not np.isnan(sigma) and sigma > 0) else 0.0

            condA = (z >= z_min) and (not np.isnan(rel)) and (rel >= relA)
            condB = (not np.isnan(q85)) and (center >= q85) and (not np.isnan(rel)) and (rel >= relB)
            if not (condA or condB): continue

            d = base["День"].iloc[i]
            creo = creative_number_for_day(d)
            if creo is not None:
                med_f = flight_meds.get(creo, np.nan)
                sig_f = flight_sigmas.get(creo, np.nan)
                if (not np.isnan(med_f)) and (not np.isnan(sig_f)):
                    if center < (med_f + 0.5 * sig_f): continue
            cand.append(i)
        return cand

    def nms_keep_max(cand_idx: list[int], min_gap_days: int = 2) -> list[int]:
        if not cand_idx: return []
        cand_idx = sorted(set(cand_idx))
        kept = []
        cluster = [cand_idx[0]]
        for a, b in zip(cand_idx, cand_idx[1:]):
            if (b - a) <= min_gap_days:
                cluster.append(b)
            else:
                ctrs = [(idx, base["CTR"].iloc[idx]) for idx in cluster]
                best = max(ctrs, key=lambda t: (0 if np.isnan(t[1]) else t[1]))[0]
                kept.append(best); cluster = [b]
        ctrs = [(idx, base["CTR"].iloc[idx]) for idx in cluster]
        best = max(ctrs, key=lambda t: (0 if np.isnan(t[1]) else t[1]))[0]
        kept.append(best)
        return kept

    relA, relB = relA0, relB0
    best_pack = ([], relA, relB, 10**9)
    mid_target = (target_low + target_high) / 2

    for _ in range(max_iters):
        cand = make_candidates(relA, relB)
        picked = nms_keep_max(cand, min_gap_days=2)
        cnt = len(picked)
        score = abs(cnt - mid_target)
        if score < best_pack[3]:
            best_pack = (picked, relA, relB, score)
        if target_low <= cnt <= target_high:
            final_indices, tuned_relA, tuned_relB = picked, relA, relB
            break
        if cnt < target_low:
            relA = max(0.0, relA - step); relB = max(0.0, relB - step)
        else:
            relA = min(0.25, relA + step); relB = min(0.25, relB + step)
    else:
        final_indices, tuned_relA, tuned_relB, _ = best_pack

    # ---------- Сбор таблицы пиков ----------
    peaks_rows = []
    for i in final_indices:
        d = base["День"].iloc[i]

        def local_above(series_name: str) -> bool:
            if series_name not in base.columns: return False
            series = base[series_name]
            left = max(0, i - W); right = min(len(series) - 1, i + W)
            win = series.iloc[left:right+1].copy()
            win = win.drop(series.index[i], errors="ignore")
            loc_mean = win.mean() if len(win) else np.nan
            val = series.iloc[i]
            return (pd.notna(val) and pd.notna(loc_mean) and val > loc_mean)

        flag_V = local_above("В")
        flag_N = local_above("Н")
        flag_O = local_above("О")

        has_creo_change = creative_change_within_plus5(d)
        titles = event_exact_titles(d)
        has_exact_event = len(titles) > 0
        titles_joined = ", ".join(titles)

        peaks_rows.append({
            "Локальные пики CTR (±10 дней) – дата": d,
            "Локальные просмотры баннеров выше – да/нет": "да" if flag_V else "нет",
            "Локально больше Н-пользователей – да/нет": "да" if flag_N else "нет",
            "Локально больше О-пользователей – да/нет": "да" if flag_O else "нет",
            "Смена креатива (в диапазоне +5 дней) – да/нет": "да" if has_creo_change else "нет",
            "Точные события в этот день – да/нет + название": ("да — " + titles_joined) if has_exact_event else "нет",
            "Активный сезон (февраль–июнь) – да/нет": "да" if in_active_season(d) else "нет",
            "Номер месяца (с 22 апреля)": month_index_from_anchor(d),
            "Номер креатива": creative_number_for_day(d) or "",
            "_CTR": base["CTR"].iloc[i],
        })

    df_peaks = pd.DataFrame(peaks_rows).sort_values("Локальные пики CTR (±10 дней) – дата").reset_index(drop=True)
    if df_peaks.empty:
        st.info("Локальные пики CTR не найдены — попробуйте увеличить период данных.")
        st.stop()

    st.caption(
        f"Пиков найдено: {len(df_peaks)} (цель: 20–25) • "
        f"порог A (z≥{z_min:.1f} и rel≥{tuned_relA*100:.1f}%), порог B (q85 и rel≥{tuned_relB*100:.1f}%) • "
        "окно: ±10 дней • смена креатива: +5 дней • NMS: минимум 2 дня между пиками"
    )

    # ---------- Таблица пиков ----------
    show_cols = [
        "Локальные пики CTR (±10 дней) – дата",
        "Локальные просмотры баннеров выше – да/нет",
        "Локально больше Н-пользователей – да/нет",
        "Локально больше О-пользователей – да/нет",
        "Смена креатива (в диапазоне +5 дней) – да/нет",
        "Точные события в этот день – да/нет + название",
        "Активный сезон (февраль–июнь) – да/нет",
        "Номер месяца (с 22 апреля)",
        "Номер креатива",
    ]
    df_show = df_peaks[show_cols].copy()
    df_show["Локальные пики CTR (±10 дней) – дата"] = df_show["Локальные пики CTR (±10 дней) – дата"].dt.strftime("%d.%m.%Y")

    st.markdown("#### Локальные пики CTR (окно ±10 дней)")
    st.dataframe(df_show, use_container_width=True, hide_index=True)

    # ---------- Карточки: доля «да» по признакам ----------
    bool_cols = [
        "Локальные просмотры баннеров выше – да/нет",
        "Локально больше Н-пользователей – да/нет",
        "Локально больше О-пользователей – да/нет",
        "Смена креатива (в диапазоне +5 дней) – да/нет",
        "Точные события в этот день – да/нет + название",
        # Активный сезон не учитываем в «совпадениях факторов» ниже, но здесь он остаётся для общей статистики.
        "Активный сезон (февраль–июнь) – да/нет",
    ]
    total = len(df_peaks)
    stats = []
    for col in bool_cols:
        if col == "Точные события в этот день – да/нет + название":
            pos = df_peaks[col].fillna("").str.startswith("да").sum()
        else:
            pos = (df_peaks[col] == "да").sum()
        pct = 0.0 if total == 0 else 100.0 * pos / total
        stats.append({"Признак": col, "Доля «да», %": pct})
    df_stats = pd.DataFrame(stats).sort_values("Доля «да», %", ascending=False).reset_index(drop=True)

    # Стили карточек
    st.markdown("""
        <style>
            .kpi-card { background:#1f2937; color:#ffffff; padding:14px 16px;
                        border-radius:14px; border:1px solid rgba(255,255,255,0.08);
                        box-shadow:0 4px 20px rgba(0,0,0,0.20); }
            .kpi-label { font-size:12px; line-height:1.2; opacity:0.95; }
            .kpi-value { font-size:24px; font-weight:700; margin-top:6px; }
        </style>
    """, unsafe_allow_html=True)

    st.markdown("#### Доли положительных признаков по всем пикам CTR (окно ±10 дней)")
    cols = st.columns(3)
    for i, row in df_stats.iterrows():
        with cols[i % 3]:
            st.markdown(
                f"""
                <div class="kpi-card">
                    <div class="kpi-label">{row['Признак']}</div>
                    <div class="kpi-value">{row['Доля «да», %']:.0f}%</div>
                </div>
                """,
                unsafe_allow_html=True,
            )

    # ---------- НОВОЕ: Карточки «совпадений факторов» (без активного сезона, номера месяца, номера креатива) ----------
    st.markdown("#### Совпадения факторов у пиков (без месяца/креатива/сезона)")

    factor_cols = [
        "Локальные просмотры баннеров выше – да/нет",
        "Локально больше Н-пользователей – да/нет",
        "Локально больше О-пользователей – да/нет",
        "Смена креатива (в диапазоне +5 дней) – да/нет",
        "Точные события в этот день – да/нет + название",
    ]

    def yes_count_row(row) -> int:
        cnt = 0
        for c in factor_cols:
            if c == "Точные события в этот день – да/нет + название":
                if isinstance(row[c], str) and row[c].startswith("да"):
                    cnt += 1
            else:
                if row[c] == "да":
                    cnt += 1
        return cnt

    df_peaks["_factors_yes"] = df_peaks.apply(yes_count_row, axis=1)

    # агрегируем: сколько пиков имеют ровно k факторов (k=0..5), показываем с 2 и выше
    max_k = len(factor_cols)
    buckets = []
    for k in range(2, max_k + 1):
        n = int((df_peaks["_factors_yes"] == k).sum())
        pct = 0.0 if total == 0 else 100.0 * n / total
        buckets.append((k, n, pct))

    # красивые подписи
    def ru_noun(n, s1, s2, s5):
        n = int(n)
        n10 = n % 10; n100 = n % 100
        if 11 <= n100 <= 14: return s5
        if n10 == 1: return s1
        if 2 <= n10 <= 4: return s2
        return s5

    cols2 = st.columns(4)
    for i, (k, n, pct) in enumerate(buckets):
        with cols2[i % 4]:
            st.markdown(
                f"""
                <div class="kpi-card">
                    <div class="kpi-label">Совпало {k} {ru_noun(k, "фактор", "фактора", "факторов")}</div>
                    <div class="kpi-value">{n} из {total} ({pct:.0f}%)</div>
                </div>
                """,
                unsafe_allow_html=True,
            )

    # ---------- Экспорт ----------
    c1, c2 = st.columns(2)
    with c1:
        st.download_button(
            "Скачать таблицу пиков (CSV)",
            data=df_show.to_csv(index=False).encode("utf-8"),
            file_name="peaks_table_robust_window10.csv",
            mime="text/csv",
        )
    with c2:
        st.download_button(
            "Скачать карточки (% «да») (CSV)",
            data=df_stats.to_csv(index=False).encode("utf-8"),
            file_name="peaks_kpi_robust_window10.csv",
            mime="text/csv",
        )






# =====================================================
# 2) СМЕНА КРЕАТИВОВ
# =====================================================
elif page == "Смена креативов":
    st.markdown("### CTR по этапам кампании (смены креативов)")

    b1 = pd.to_datetime("2025-04-23")
    b2 = pd.to_datetime("2025-07-07")
    b3 = pd.to_datetime("2025-08-14")
    b4 = pd.to_datetime("2025-10-22")
    b5 = pd.to_datetime("2025-10-29")

    df2 = df_ctr.dropna(subset=["CTR"]).copy()

    fig2 = go.Figure()

    seg1 = df2[(df2["День"] >= b1) & (df2["День"] < b2)]
    fig2.add_trace(go.Scatter(x=seg1["День"], y=seg1["CTR"], mode="lines+markers", name="23.04 – 07.07",
                              line=dict(color="rgba(141,181,255,1)", width=2.2), marker=dict(size=4),
                              hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>"))
    seg2 = df2[(df2["День"] >= b2) & (df2["День"] < b3)]
    fig2.add_trace(go.Scatter(x=seg2["День"], y=seg2["CTR"], mode="lines+markers", name="07.07 – 14.08",
                              line=dict(color="rgba(102,204,153,1)", width=2.2), marker=dict(size=4),
                              hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>"))
    seg3 = df2[(df2["День"] >= b3) & (df2["День"] < b4)]
    fig2.add_trace(go.Scatter(x=seg3["День"], y=seg3["CTR"], mode="lines+markers", name="14.08 – 22.10",
                              line=dict(color="rgba(255,159,67,1)", width=2.2), marker=dict(size=4),
                              hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>"))
    seg4 = df2[(df2["День"] >= b4) & (df2["День"] <= b5)]
    fig2.add_trace(go.Scatter(x=seg4["День"], y=seg4["CTR"], mode="lines+markers", name="22.10 – 29.10",
                              line=dict(color="rgba(255,221,87,1)", width=2.2), marker=dict(size=4),
                              hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>"))

    fig2.update_layout(
        height=520, margin=dict(l=20, r=20, t=40, b=40), xaxis_title="Дата", yaxis_title="CTR",
        hovermode="x unified", plot_bgcolor="rgba(0,0,0,0)", paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    fig2.update_yaxes(tickformat=".2%")
    st.plotly_chart(fig2, use_container_width=True)

    def make_window(df, center_date, days=3):
        win = df[(df["День"] >= center_date - pd.Timedelta(days=days)) &
                 (df["День"] <= center_date + pd.Timedelta(days=days))].copy()
        win["Дата"] = win["День"].dt.strftime("%d.%m.%Y")
        win["CTR (в %)"] = win["CTR"].map(lambda x: f"{x:.2%}")
        return win[["Дата", "CTR (в %)"]]

    def render_small_table(df_table, title, highlight_date, color_hex):
        st.markdown(f"**{title}**")
        html = "<table style='width:100%;max-width:260px;border-collapse:collapse;font-size:0.85rem;'>"
        html += "<tr><th style='text-align:left;padding:4px 6px;border-bottom:1px solid #555;'>Дата</th>"
        html += "<th style='text-align:right;padding:4px 6px;border-bottom:1px solid #555;'>CTR</th></tr>"
        target_str = highlight_date.strftime("%d.%m.%Y")
        for _, row in df_table.iterrows():
            bg = f"background-color:{color_hex};" if row["Дата"] == target_str else ""
            html += f"<tr style='{bg}'><td style='padding:3px 6px;'>{row['Дата']}</td>"
            html += f"<td style='padding:3px 6px;text-align:right;'>{row['CTR (в %)']}</td></tr>"
        html += "</table>"
        st.markdown(html, unsafe_allow_html=True)

    win_b1 = make_window(df2, b1, 3)
    win_b2 = make_window(df2, b2, 3)
    win_b3 = make_window(df2, b3, 3)
    win_b4 = make_window(df2, b4, 3)

    c1, c2, c3, c4 = st.columns(4)
    with c1: render_small_table(win_b1, "1 ФЛАЙТ", b1, "#8DB5FF55")
    with c2: render_small_table(win_b2, "2 ФЛАЙТ", b2, "#66CC9955")
    with c3: render_small_table(win_b3, "3 ФЛАЙТ", b3, "#FF9F4355")
    with c4: render_small_table(win_b4, "4 ФЛАЙТ", b4, "#FFDD5755")

# =====================================================
# 3) СПОРТИВНЫЕ СОБЫТИЯ
# =====================================================
elif page == "Спортивные события":
    min_date = pd.to_datetime("2025-04-23")
    max_date = df_ctr["День"].max()

    st.markdown("<div style='text-align:center;margin-top:0.5rem;margin-bottom:0.5rem;'><b>Фильтры</b></div>", unsafe_allow_html=True)
    col_l, col_c, col_r = st.columns([1, 2.5, 1])
    with col_c:
        date_from, date_to = st.slider(
            "Диапазон дат",
            min_value=min_date.to_pydatetime(),
            max_value=max_date.to_pydatetime(),
            value=(min_date.to_pydatetime(), max_date.to_pydatetime()),
            format="DD.MM.YYYY",
        )
        top_n = st.number_input("Пиков CTR вывести", min_value=3, max_value=50, value=15, step=1)

    date_from = pd.to_datetime(date_from)
    date_to = pd.to_datetime(date_to)

    df_view = df_ctr[(df_ctr["День"] >= date_from) & (df_ctr["День"] <= date_to)].copy()
    df_view = df_view.dropna(subset=["CTR"]).sort_values("День")

    def exact_events_for_day(d: pd.Timestamp) -> str:
        names = []
        for _, ev in df_events.iterrows():
            if ev["начало"].date() == d.date() or ev["окончание"].date() == d.date():
                names.append(ev["название"])
        return ", ".join(names)

    def interval_events_for_day(d: pd.Timestamp) -> str:
        names = []
        for _, ev in df_events.iterrows():
            if ev["начало"] <= d <= ev["окончание"]:
                names.append(ev["название"])
        return ", ".join(names)

    df_view["CTR_prev"] = df_view["CTR"].shift(1)
    df_view["CTR_change"] = (df_view["CTR"] - df_view["CTR_prev"]) / df_view["CTR_prev"]
    df_view["Событие (точное)"] = df_view["День"].apply(exact_events_for_day)

    CTR_EVENT_THR = 0.12

    def is_dependent(row):
        if not row["Событие (точное)"]: return False
        if pd.isna(row["CTR_change"]): return False
        return abs(row["CTR_change"]) >= CTR_EVENT_THR

    df_view["dependent_move"] = df_view.apply(is_dependent, axis=1)
    dependent_count = int(df_view["dependent_move"].sum())

    sport_colors = {
        "Хоккей": "rgba(46, 204, 113, 0.12)",
        "Баскетбол": "rgba(52, 152, 219, 0.12)",
        "Футбол": "rgba(231, 76, 60, 0.12)",
        "Теннис": "rgba(155, 89, 182, 0.12)",
        "UFC": "rgba(241, 196, 15, 0.12)",
    }

    fig = go.Figure()
    fig.add_trace(go.Scatter(
        x=df_view["День"], y=df_view["CTR"], mode="lines+markers", name="CTR",
        line=dict(width=2.2, color="rgba(181, 220, 255, 1)"), marker=dict(size=4),
        hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
    ))

    for _, ev in df_events.iterrows():
        if ev["окончание"] < date_from or ev["начало"] > date_to:
            continue
        x0 = max(ev["начало"], date_from)
        x1 = min(ev["окончание"], date_to)
        fill = sport_colors.get(ev["вид спорта"], "rgba(255,255,255,0.05)")

        fig.add_vrect(x0=x0, x1=x1, fillcolor=fill, layer="below", line_width=0)
        fig.add_vline(x=ev["начало"], line_width=0.8, line_dash="dash", line_color="rgba(255,255,255,0.4)")
        fig.add_annotation(
            x=x0, y=1.03, xref="x", yref="paper", text=ev["название"],
            showarrow=False, xanchor="left", font=dict(size=10, color="#ffffff"), textangle=65,
        )

    fig.update_layout(
        height=560, margin=dict(l=20, r=20, t=90, b=40),
        xaxis_title="Дата", yaxis_title="CTR", hovermode="x unified",
        plot_bgcolor="rgba(0,0,0,0)", paper_bgcolor="rgba(0,0,0,0)",
    )
    fig.update_xaxes(range=[date_from, date_to], showgrid=False)
    fig.update_yaxes(showgrid=True, zeroline=False, tickformat=".2%")
    st.plotly_chart(fig, use_container_width=True)

    st.markdown(f"**Зависимых сдвигов:** {dependent_count}")

    peaks = df_view.sort_values("CTR", ascending=False).head(top_n).copy()
    peaks["Дата"] = peaks["День"].dt.strftime("%d.%m.%Y")
    peaks["CTR (в %)"] = peaks["CTR"].map(lambda x: f"{x:.2%}")
    peaks["Событие (точное)"] = peaks["День"].apply(exact_events_for_day)
    peaks["События (в интервале)"] = peaks["День"].apply(interval_events_for_day)

    st.markdown("### Пиковые значения CTR")
    st.dataframe(
        peaks[["Дата", "CTR (в %)", "Событие (точное)", "События (в интервале)"]],
        use_container_width=True, hide_index=True,
    )

# =====================================================
# 4) ТРАФИК В РАЗДЕЛЕ (CTR vs Просмотры "в разделе")
# =====================================================
elif page == "Трафик в разделе":
    st.markdown("### Трафик в разделе: CTR (красная) и Просмотры (синяя)")

    df_ctr_short = df_ctr[["День", "CTR"]].copy().sort_values("День")
    df_traf = df_section.rename(columns={"Период": "День", "Просмотры": "Просмотры (раздел)"}).copy()
    df_mix = pd.merge(df_ctr_short, df_traf, on="День", how="outer").sort_values("День").reset_index(drop=True)

    min_date = df_mix["День"].min()
    max_date = df_mix["День"].max()

    st.markdown("<div style='text-align:center;margin-top:0.5rem;margin-bottom:0.5rem;'><b>Фильтры</b></div>", unsafe_allow_html=True)
    col_l, col_c, col_r = st.columns([1, 2.5, 1])
    with col_c:
        date_from, date_to = st.slider(
            "Диапазон дат",
            min_value=min_date.to_pydatetime(),
            max_value=max_date.to_pydatetime(),
            value=(min_date.to_pydatetime(), max_date.to_pydatetime()),
            format="DD.MM.YYYY",
        )

    date_from = pd.to_datetime(date_from)
    date_to = pd.to_datetime(date_to)
    df_view = df_mix[(df_mix["День"] >= date_from) & (df_mix["День"] <= date_to)].copy()

    # ----- График 1: дневные значения -----
    figx = go.Figure()
    figx.add_trace(
        go.Scatter(
            x=df_view["День"], y=df_view["CTR"], mode="lines+markers", name="CTR",
            line=dict(color="rgba(255,80,80,1)", width=2.2), marker=dict(size=4),
            hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>", yaxis="y1",
        )
    )
    figx.add_trace(
        go.Scatter(
            x=df_view["День"], y=df_view["Просмотры (раздел)"], mode="lines+markers", name="Просмотры (раздел)",
            line=dict(color="rgba(80,140,255,1)", width=2.0), marker=dict(size=3),
            hovertemplate="%{x|%d.%m.%Y}<br>Просмотры: %{y:,}<extra></extra>", yaxis="y2",
        )
    )
    figx.update_layout(
        height=560, margin=dict(l=20, r=20, t=40, b=40),
        xaxis=dict(title="Дата", range=[date_from, date_to], showgrid=False),
        yaxis=dict(title="CTR", showgrid=True, zeroline=False, tickformat=".2%"),
        yaxis2=dict(title="Просмотры (раздел)", overlaying="y", side="right", showgrid=False),
        hovermode="x unified", plot_bgcolor="rgba(0,0,0,0)", paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    st.plotly_chart(figx, use_container_width=True)

          # ----- График 2: тренды (переключатель Недели/Месяцы) -----
    st.markdown("### Тренды (агрегация)")

    view_mode = st.radio(
        "Агрегация тренда",
        options=["По неделям", "По месяцам"],
        index=0,
        horizontal=True,
        help="Средний CTR за период и сумма просмотров за период",
    )

    def make_weekly(df_in: pd.DataFrame) -> pd.DataFrame:
        w = (
            df_in.set_index("День")
            .resample("W-MON")  # недели с понедельника
            .agg({"CTR": "mean", "Просмотры (раздел)": "sum"})
            .reset_index()
            .rename(columns={"День": "Период"})
        )
        w["Период_конец"] = w["Период"] + pd.Timedelta(days=6)
        w["label"] = w["Период"].dt.strftime("%d.%m") + "–" + w["Период_конец"].dt.strftime("%d.%m.%Y")
        return w

    def make_monthly(df_in: pd.DataFrame) -> pd.DataFrame:
        m = (
            df_in.set_index("День")
            .resample("MS")  # начало месяца
            .agg({"CTR": "mean", "Просмотры (раздел)": "sum"})
            .reset_index()
            .rename(columns={"День": "Период"})
        )
        m["label"] = m["Период"].dt.strftime("%b %Y")
        return m

    if view_mode == "По неделям":
        agg = make_weekly(df_view)
        title_ctr = "CTR (ср. за неделю)"
        title_views = "Просмотры (сумма за неделю)"
        hover_ctr = "Неделя: %{text}<br>CTR (ср.): %{y:.2%}<extra></extra>"
        hover_views = "Неделя: %{text}<br>Просмотры: %{y:,}<extra></extra>"
        xaxis_title = "Неделя (дата начала, пн)"
    else:
        agg = make_monthly(df_view)
        title_ctr = "CTR (ср. за месяц)"
        title_views = "Просмотры (сумма за месяц)"
        hover_ctr = "Месяц: %{text}<br>CTR (ср.): %{y:.2%}<extra></extra>"
        hover_views = "Месяц: %{text}<br>Просмотры: %{y:,}<extra></extra>"
        xaxis_title = "Месяц"

    fig_trend = go.Figure()
    fig_trend.add_trace(
        go.Scatter(
            x=agg["Период"], y=agg["CTR"], mode="lines+markers", name=title_ctr,
            line=dict(width=2.6), marker=dict(size=5),
            text=agg["label"], hovertemplate=hover_ctr, yaxis="y1",
        )
    )
    fig_trend.add_trace(
        go.Scatter(
            x=agg["Период"], y=agg["Просмотры (раздел)"], mode="lines+markers", name=title_views,
            line=dict(width=2.4), marker=dict(size=5),
            text=agg["label"], hovertemplate=hover_views, yaxis="y2",
        )
    )
    fig_trend.update_layout(
        height=520, margin=dict(l=20, r=20, t=30, b=40),
        xaxis=dict(title=xaxis_title, showgrid=False),
        yaxis=dict(title=title_ctr, showgrid=True, zeroline=False, tickformat=".2%"),
        yaxis2=dict(title=title_views, overlaying="y", side="right", showgrid=False),
        hovermode="x unified",
        plot_bgcolor="rgba(0,0,0,0)", paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    st.plotly_chart(fig_trend, use_container_width=True)



    # Таблица для удобного экспорта/просмотра
    df_peek = df_view.copy()
    df_peek["Дата"] = df_peek["День"].dt.strftime("%d.%m.%Y")
    df_peek["CTR (в %)"] = df_peek["CTR"].map(lambda x: f"{x:.2%}" if pd.notna(x) else "")
    st.dataframe(df_peek[["Дата", "CTR (в %)", "Просмотры (раздел)"]], hide_index=True, use_container_width=True)

# =====================================================
# 5) ПРОСМОТРЫ (основные)
# =====================================================
elif page == "Просмотры":
    st.markdown("### CTR vs Просмотры (по дням)")

    min_date = pd.to_datetime("2025-04-23")
    max_date = df_ctr["День"].max()

    st.markdown("<div style='text-align:center;margin-top:0.5rem;margin-bottom:0.5rem;'><b>Фильтры</b></div>", unsafe_allow_html=True)
    col_l, col_c, col_r = st.columns([1, 2.5, 1])
    with col_c:
        date_from, date_to = st.slider(
            "Диапазон дат",
            min_value=min_date.to_pydatetime(),
            max_value=max_date.to_pydatetime(),
            value=(min_date.to_pydatetime(), max_date.to_pydatetime()),
            format="DD.MM.YYYY",
        )
        top_n = st.number_input("Пиков CTR вывести", min_value=3, max_value=50, value=15, step=1)

    date_from = pd.to_datetime(date_from)
    date_to = pd.to_datetime(date_to)

    df3 = df_ctr[(df_ctr["День"] >= date_from) & (df_ctr["День"] <= date_to)].copy()
    df3 = df3.dropna(subset=["CTR"]).sort_values("День")

    df3["CTR_prev"] = df3["CTR"].shift(1)
    df3["Views_prev"] = df3["Просмотры"].shift(1)
    df3["CTR_change"] = (df3["CTR"] - df3["CTR_prev"]) / df3["CTR_prev"]
    df3["Views_change"] = (df3["Просмотры"] - df3["Views_prev"]) / df3["Views_prev"]

    CTR_THR = 0.12
    VIEWS_THR = 0.12

    def is_joint3(row):
        if pd.isna(row["CTR_change"]) or pd.isna(row["Views_change"]): return False
        if row["CTR_change"] > CTR_THR and row["Views_change"] > VIEWS_THR: return True
        if row["CTR_change"] < -CTR_THR and row["Views_change"] < -VIEWS_THR: return True
        return False

    df3["joint_move"] = df3.apply(is_joint3, axis=1)
    joint_days = df3[df3["joint_move"]]

    fig3 = go.Figure()
    fig3.add_trace(go.Scatter(
        x=df3["День"], y=df3["CTR"], mode="lines+markers", name="CTR",
        line=dict(color="rgba(102,178,255,1)", width=2.2), marker=dict(size=4),
        hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>", yaxis="y1",
    ))
    fig3.add_trace(go.Scatter(
        x=df3["День"], y=df3["Просмотры"], mode="lines+markers", name="Просмотры",
        line=dict(color="rgba(255,159,67,1)", width=2.0), marker=dict(size=3),
        hovertemplate="%{x|%d.%m.%Y}<br>Просмотры: %{y:,}<extra></extra>", yaxis="y2",
    ))
    for _, row in joint_days.iterrows():
        fig3.add_vline(x=row["День"], line_width=1.1, line_dash="dot", line_color="rgba(255,80,80,0.85)")

    fig3.update_layout(
        height=560, margin=dict(l=20, r=20, t=40, b=40),
        xaxis=dict(title="Дата", range=[date_from, date_to], showgrid=False),
        yaxis=dict(title="CTR", showgrid=True, zeroline=False, tickformat=".2%"),
        yaxis2=dict(title="Просмотры", overlaying="y", side="right", showgrid=False),
        hovermode="x unified", plot_bgcolor="rgba(0,0,0,0)", paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    st.plotly_chart(fig3, use_container_width=True)

    st.markdown(f"**Совместных сильных движений (CTR и Просмотры вместе):** {len(joint_days)}")

    avg_views = df3["Просмотры"].mean()
    peaks3 = df3.sort_values("CTR", ascending=False).head(top_n).copy()
    peaks3["Дата"] = peaks3["День"].dt.strftime("%d.%m.%Y")
    peaks3["CTR (в %)"] = peaks3["CTR"].map(lambda x: f"{x:.2%}")
    peaks3["Уровень просмотров"] = peaks3["Просмотры"].apply(lambda v: "выше среднего" if v >= avg_views else "ниже среднего")
    st.markdown("### Пиковые значения CTR в выбранный период")
    st.dataframe(
        peaks3[["Дата", "CTR (в %)", "Просмотры", "Уровень просмотров"]],
        use_container_width=True, hide_index=True,
    )
    # =====================================================
# 7) ОБЩИЙ ТРАФИК — Н / В / О + CTR
# =====================================================
elif page == "Общий трафик":
    st.markdown("### Общий трафик: Н / В / О + CTR")

    # Собираем общую таблицу дат
    base_dates = pd.DataFrame({"День": pd.date_range(
        start=min(df_N["День"].min(), df_V["День"].min(), df_O["День"].min(), df_ctr["День"].min()),
        end=max(df_N["День"].max(), df_V["День"].max(), df_O["День"].max(), df_ctr["День"].max()),
        freq="D"
    )})

    # Объединяем ряды
    df_total = base_dates.merge(df_N, on="День", how="left") \
                         .merge(df_V, on="День", how="left") \
                         .merge(df_O, on="День", how="left") \
                         .merge(df_ctr[["День", "CTR"]], on="День", how="left")

    # Фильтры диапазона
    min_date = df_total["День"].min(); max_date = df_total["День"].max()
    st.markdown("<div style='text-align:center;margin-top:0.5rem;margin-bottom:0.5rem;'><b>Фильтры</b></div>", unsafe_allow_html=True)
    col_l, col_c, col_r = st.columns([1, 2.5, 1])
    with col_c:
        date_from, date_to = st.slider(
            "Диапазон дат",
            min_value=min_date.to_pydatetime(),
            max_value=max_date.to_pydatetime(),
            value=(min_date.to_pydatetime(), max_date.to_pydatetime()),
            format="DD.MM.YYYY",
        )

    df_view = df_total[(df_total["День"] >= pd.to_datetime(date_from)) & (df_total["День"] <= pd.to_datetime(date_to))].copy()

    # Переключатели линий
    c1, c2, c3, c4, c5 = st.columns(5)
    with c1: show_N = st.checkbox("Показать «Н»", True)
    with c2: show_V = st.checkbox("Показать «В»", True)
    with c3: show_O = st.checkbox("Показать «О»", True)
    with c4: show_CTR = st.checkbox("Показать CTR", True)
    with c5: smooth = st.checkbox("Сгладить (7 дн.)", False, help="Простое скользящее среднее")

    if smooth:
        for col in ["Н", "В", "О"]:
            if col in df_view:
                df_view[col] = df_view[col].rolling(7, min_periods=1, center=False).mean()
        if "CTR" in df_view:
            df_view["CTR"] = df_view["CTR"].rolling(7, min_periods=1, center=False).mean()

    # График
    fig = go.Figure()

    def add_line(ycol, name, color, width=2.0):
        fig.add_trace(go.Scatter(
            x=df_view["День"], y=df_view[ycol], mode="lines", name=name,
            line=dict(color=color, width=width), hovertemplate="%{x|%d.%m.%Y}<br>%{y:,}<extra></extra>", yaxis="y1"
        ))

    if show_N and "Н" in df_view: add_line("Н", "Н", "rgba(59,130,246,1)", 2.4)
    if show_V and "В" in df_view: add_line("В", "В", "rgba(16,185,129,1)", 2.2)
    if show_O and "О" in df_view: add_line("О", "О", "rgba(234,179,8,1)", 2.2)

    if show_CTR and "CTR" in df_view:
        fig.add_trace(go.Scatter(
            x=df_view["День"], y=df_view["CTR"], mode="lines", name="CTR",
            line=dict(color="rgba(239,68,68,1)", width=2.4, dash="dash"),
            hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>", yaxis="y2"
        ))

    fig.update_layout(
        height=560, margin=dict(l=20, r=20, t=40, b=40),
        xaxis=dict(title="Дата", range=[pd.to_datetime(date_from), pd.to_datetime(date_to)], showgrid=False),
        yaxis=dict(title="Трафик (Н/В/О)", showgrid=True, zeroline=False, tickformat=","),
        yaxis2=dict(title="CTR", overlaying="y", side="right", showgrid=False, tickformat=".2%"),
        hovermode="x unified", plot_bgcolor="rgba(0,0,0,0)", paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    st.plotly_chart(fig, use_container_width=True)

    # Таблица + экспорт
    df_out = df_view.copy()
    df_out["Дата"] = df_out["День"].dt.strftime("%d.%m.%Y")
    if "CTR" in df_out:
        df_out["CTR (в %)"] = df_out["CTR"].map(lambda x: f"{x:.2%}" if pd.notna(x) else "")
    cols = ["Дата"] + [c for c, flag in [("Н", show_N), ("В", show_V), ("О", show_O)] if flag]
    if show_CTR: cols += ["CTR (в %)"]
    st.dataframe(df_out[cols], use_container_width=True, hide_index=True)

    csv = df_out[["День"] + [c for c in ["Н","В","О","CTR"] if c in df_out]].to_csv(index=False).encode("utf-8")
    st.download_button("Скачать CSV (видимые ряды)", data=csv, file_name="traffic_total.csv", mime="text/csv")
# =====================================================
# 6) ДРУГИЕ РК — сравнение CTR
# =====================================================
else:  # "Другие РК"
    st.markdown("### Другие РК: сравнение CTR")

    # --- Базовая серия
    base = df_ctr[["День", "CTR"]].dropna().copy().sort_values("День")

    # --- Список серий
    series = []
    series.append({
        "key": "BASE",
        "label": "Основная серия",
        "df": base.copy(),
        "style": {"dash": "solid", "width": 2.4, "color": "rgba(52,152,219,1)", "marker_size": 4},
    })
    for s in EXTRA_SERIES:
        series.append({
            "key": f"EXTRA_{s['name']}",
            "label": f"Серия «{s['name']}»",
            "df": s["df"].copy().dropna().sort_values("День"),
            "style": s.get("style", {"dash": "dot", "width": 2.2, "color": "rgba(255,99,132,1)", "marker_size": 4}),
        })

    # --- Границы дат
    min_date = min([s["df"]["День"].min() for s in series if not s["df"].empty])
    max_date = max([s["df"]["День"].max() for s in series if not s["df"].empty])

    # --- Фильтры
    st.markdown("<div style='text-align:center;margin-top:0.5rem;margin-bottom:0.5rem;'><b>Фильтры</b></div>", unsafe_allow_html=True)
    col_l, col_c, col_r = st.columns([1, 2.5, 1])
    with col_c:
        date_from, date_to = st.slider(
            "Диапазон дат",
            min_value=min_date.to_pydatetime(),
            max_value=max_date.to_pydatetime(),
            value=(min_date.to_pydatetime(), max_date.to_pydatetime()),
            format="DD.MM.YYYY",
        )

    date_from = pd.to_datetime(date_from); date_to = pd.to_datetime(date_to)

    # --- Настройки отображения
    opt_col1, opt_col2 = st.columns([1, 1.5])
    with opt_col1:
        show_lines = st.radio(
            "Отображение линий совпадений:",
            ["С линиями", "Без линий"],
            horizontal=True,
            index=0,
        )
    with opt_col2:
        trend_mode = st.radio(
            "Тренды:",
            ["По неделям", "По месяцам"],
            horizontal=True,
            index=0,
        )

    # =====================================================
    # ГРАФИК 1 — ДНЕВНОЙ CTR С ВЕРТИКАЛЬНЫМИ ЛИНИЯМИ
    # =====================================================
    def add_trace(fig, df_src, label, style):
        if df_src.empty:
            return
        fig.add_trace(
            go.Scatter(
                x=df_src["День"], y=df_src["CTR"], mode="lines+markers", name=label,
                line=dict(color=style.get("color"), width=style.get("width"), dash=style.get("dash")),
                marker=dict(size=style.get("marker_size", 4)),
                hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
            )
        )

    # --- Определение тенденций
    def with_sign(df_in: pd.DataFrame) -> pd.DataFrame:
        d = df_in[(df_in["День"] >= date_from) & (df_in["День"] <= date_to)].copy().sort_values("День")
        d["prev"] = d["CTR"].shift(1)
        d["chg"] = d["CTR"] - d["prev"]
        d["sign"] = d["chg"].apply(lambda v: 1 if pd.notna(v) and v > 0 else (-1 if pd.notna(v) and v < 0 else 0))
        return d[["День", "CTR", "sign"]]

    series_view = []
    for s in series:
        series_view.append({**s, "dfv": with_sign(s["df"])})

    # --- Подготовка данных для совпадений
    all_dates = pd.DataFrame({"День": pd.date_range(date_from, date_to, freq="D")})
    signs_df = all_dates.copy()
    for s in series_view:
        col = f"sign_{s['key']}"
        signs_df = signs_df.merge(s["dfv"][["День", "sign"]].rename(columns={"sign": col}), on="День", how="left")

    marks_white, marks_green = [], []
    for _, row in signs_df.iterrows():
        vals = [v for k, v in row.items() if str(k).startswith("sign_")]
        vals = [int(v) for v in vals if pd.notna(v) and v != 0]
        if len(vals) < 2:
            continue
        up = sum(1 for v in vals if v == 1)
        dn = sum(1 for v in vals if v == -1)
        consensus = max(up, dn)
        if consensus >= 3:
            marks_green.append(row["День"])
        elif consensus == 2:
            marks_white.append(row["День"])

    # --- Построение графика
    fig = go.Figure()
    for s in series_view:
        add_trace(fig, s["dfv"], s["label"], s["style"])

    if show_lines == "С линиями":
        for d in marks_white:
            fig.add_vline(x=d, line_width=1.2, line_dash="dot", line_color="rgba(255,255,255,0.95)")
        for d in marks_green:
            fig.add_vline(x=d, line_width=1.6, line_dash="solid", line_color="rgba(46,204,113,0.95)")

    fig.update_layout(
        height=560,
        margin=dict(l=20, r=20, t=40, b=40),
        xaxis=dict(title="Дата", range=[date_from, date_to], showgrid=False),
        yaxis=dict(title="CTR", showgrid=True, zeroline=False, tickformat=".2%"),
        hovermode="x unified",
        plot_bgcolor="rgba(0,0,0,0)",
        paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    st.plotly_chart(fig, use_container_width=True)

    if show_lines == "С линиями":
        st.markdown(
            "<div style='color:#94a3b8;margin-top:-0.5rem;margin-bottom:0.7rem;'>"
            "Вертикальные линии: <b style='color:#e5e7eb;'>белая</b> — совпадение тенденции у двух кампаний; "
            "<b style='color:#22c55e;'>зелёная</b> — у трёх и более.</div>",
            unsafe_allow_html=True,
        )

    # =====================================================
    # ГРАФИК 2 — ЛИНИИ ТРЕНДА (НЕДЕЛИ / МЕСЯЦЫ)
    # =====================================================
    st.markdown("### Линии тренда")

    def monthly_ctr(df_in: pd.DataFrame) -> pd.DataFrame:
        if df_in.empty:
            return pd.DataFrame(columns=["Период", "CTR"])
        out = (
            df_in[(df_in["День"] >= date_from) & (df_in["День"] <= date_to)]
            .set_index("День")
            .resample("MS")
            .agg({"CTR": "mean"})
            .reset_index()
            .rename(columns={"День": "Период"})
        )
        out["label"] = out["Период"].dt.strftime("%b %Y")
        return out

    def weekly_ctr(df_in: pd.DataFrame) -> pd.DataFrame:
        if df_in.empty:
            return pd.DataFrame(columns=["Период", "CTR"])
        out = (
            df_in[(df_in["День"] >= date_from) & (df_in["День"] <= date_to)]
            .set_index("День")
            .resample("W-MON")
            .agg({"CTR": "mean"})
            .reset_index()
            .rename(columns={"День": "Период"})
        )
        out["Период_конец"] = out["Период"] + pd.Timedelta(days=6)
        out["label"] = out["Период"].dt.strftime("%d.%m") + "–" + out["Период_конец"].dt.strftime("%d.%m.%Y")
        return out

    figm = go.Figure()
    for s in series:
        m = weekly_ctr(s["df"]) if trend_mode == "По неделям" else monthly_ctr(s["df"])
        title_y = "CTR (ср. за неделю)" if trend_mode == "По неделям" else "CTR (ср. за месяц)"
        x_title = "Неделя (начало, пн)" if trend_mode == "По неделям" else "Месяц"

        if m.empty:
            continue
        stl = s["style"]
        figm.add_trace(
            go.Scatter(
                x=m["Период"], y=m["CTR"], mode="lines+markers",
                name=f"{s['label']} ({trend_mode.lower()})",
                line=dict(color=stl.get("color"), width=max(2.4, stl.get("width", 2.4)), dash=stl.get("dash", "solid")),
                marker=dict(size=5),
                text=m["label"],
                hovertemplate="%{text}<br>CTR (ср.): %{y:.2%}<extra></extra>",
            )
        )

    figm.update_layout(
        height=520,
        margin=dict(l=20, r=20, t=30, b=40),
        xaxis=dict(title=x_title, showgrid=False),
        yaxis=dict(title=title_y, showgrid=True, zeroline=False, tickformat=".2%"),
        hovermode="x unified",
        plot_bgcolor="rgba(0,0,0,0)",
        paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    st.plotly_chart(figm, use_container_width=True)
