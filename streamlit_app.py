import streamlit as st
import pandas as pd
import plotly.graph_objects as go

# -----------------------------------------------------
# –ù–ê–°–¢–†–û–ô–ö–ê
# -----------------------------------------------------
st.set_page_config(page_title="CTR // –î–∞–Ω–Ω—ã–µ", layout="wide")

# -----------------------------------------------------
# –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
# -----------------------------------------------------
if "auth_ok" not in st.session_state:
    st.session_state.auth_ok = False

if not st.session_state.auth_ok:
    st.markdown(
        """
        <div style="text-align:center;margin-top:4rem;">
            <h2>–î–æ—Å—Ç—É–ø</h2>
            <p style="color:#9ca3af;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
        </div>
        """,
        unsafe_allow_html=True,
    )
    pwd = st.text_input("–ü–∞—Ä–æ–ª—å", type="password", label_visibility="collapsed")
    if pwd == "SportsTeam":
        st.session_state.auth_ok = True
        st.rerun()
    st.stop()

# -----------------------------------------------------
# –î–ê–ù–ù–´–ï (–∏–∑ ¬´–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ 10¬ª)
# -----------------------------------------------------
CTR_DATA = [
    {"–î–µ–Ω—å": "2025-04-23", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 265237, "CTR": 0.0054},
    {"–î–µ–Ω—å": "2025-04-24", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 426884, "CTR": 0.0051},
    {"–î–µ–Ω—å": "2025-04-25", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 413081, "CTR": 0.0049},
    {"–î–µ–Ω—å": "2025-04-26", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 481718, "CTR": 0.0069},
    {"–î–µ–Ω—å": "2025-04-27", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 623013, "CTR": 0.0064},
    {"–î–µ–Ω—å": "2025-04-28", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 472590, "CTR": 0.0050},
    {"–î–µ–Ω—å": "2025-04-29", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 500183, "CTR": 0.0048},
    {"–î–µ–Ω—å": "2025-04-30", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 517238, "CTR": 0.0042},
    {"–î–µ–Ω—å": "2025-05-01", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 244971, "CTR": 0.0036},
    {"–î–µ–Ω—å": "2025-05-02", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 371701, "CTR": 0.0038},
    {"–î–µ–Ω—å": "2025-05-03", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 437894, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-05-04", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 561845, "CTR": 0.0049},
    {"–î–µ–Ω—å": "2025-05-05", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 476233, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-05-06", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 471161, "CTR": 0.0037},
    {"–î–µ–Ω—å": "2025-05-07", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 471216, "CTR": 0.0040},
    {"–î–µ–Ω—å": "2025-05-08", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 485460, "CTR": 0.0037},
    {"–î–µ–Ω—å": "2025-05-09", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 422336, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-05-10", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 454709, "CTR": 0.0039},
    {"–î–µ–Ω—å": "2025-05-11", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 558409, "CTR": 0.0037},
    {"–î–µ–Ω—å": "2025-05-12", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 565616, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-05-13", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 547357, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-05-14", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 526545, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-05-15", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 535184, "CTR": 0.0038},
    {"–î–µ–Ω—å": "2025-05-16", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 516963, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-05-17", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 500540, "CTR": 0.0037},
    {"–î–µ–Ω—å": "2025-05-18", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 462166, "CTR": 0.0049},
    {"–î–µ–Ω—å": "2025-05-19", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 538880, "CTR": 0.0037},
    {"–î–µ–Ω—å": "2025-05-20", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 541629, "CTR": 0.0036},
    {"–î–µ–Ω—å": "2025-05-21", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 527592, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-05-22", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 460450, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-05-23", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 467756, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-05-24", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 534840, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-05-25", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 506351, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-05-26", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 522780, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-05-27", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 478067, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-05-28", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 509517, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-05-29", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 531466, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-05-30", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 524913, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-05-31", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 462039, "CTR": 0.0040},
    {"–î–µ–Ω—å": "2025-06-01", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 465341, "CTR": 0.0044},
    {"–î–µ–Ω—å": "2025-06-02", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 535146, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-06-03", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 560600, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-06-04", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 559671, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-06-05", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 575665, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-06-06", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 561396, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-06-07", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 465010, "CTR": 0.0046},
    {"–î–µ–Ω—å": "2025-06-08", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 508173, "CTR": 0.0041},
    {"–î–µ–Ω—å": "2025-06-09", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 567428, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-06-10", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 531868, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-06-11", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 523310, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-06-12", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 469664, "CTR": 0.0042},
    {"–î–µ–Ω—å": "2025-06-13", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 502609, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-06-14", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 472580, "CTR": 0.0044},
    {"–î–µ–Ω—å": "2025-06-15", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 525757, "CTR": 0.0043},
    {"–î–µ–Ω—å": "2025-06-16", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 591741, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-06-17", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 558300, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-06-18", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 619877, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-06-19", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 504746, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-06-20", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 507177, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-06-21", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 529465, "CTR": 0.0038},
    {"–î–µ–Ω—å": "2025-06-22", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 557972, "CTR": 0.0036},
    {"–î–µ–Ω—å": "2025-06-23", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 720505, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-06-24", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 557098, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-06-25", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 553033, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-06-26", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 542082, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-06-27", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 555067, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-06-28", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 541955, "CTR": 0.0037},
    {"–î–µ–Ω—å": "2025-06-29", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 559450, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-06-30", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 571918, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-07-01", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 542226, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-07-02", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 550525, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-07-03", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 538977, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-07-04", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 559607, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-07-05", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 546075, "CTR": 0.0037},
    {"–î–µ–Ω—å": "2025-07-06", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 556872, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-07-07", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 559247, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-07-08", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 550701, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-07-09", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 546590, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-07-10", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 538504, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-07-11", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 547488, "CTR": 0.0032},
    {"–î–µ–Ω—å": "2025-07-12", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 518794, "CTR": 0.0036},
    {"–î–µ–Ω—å": "2025-07-13", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 532777, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-07-14", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 566576, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-07-15", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 553796, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-07-16", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 551008, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-07-17", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 557916, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-07-18", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 543210, "CTR": 0.0032},
    {"–î–µ–Ω—å": "2025-07-19", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 534881, "CTR": 0.0037},
    {"–î–µ–Ω—å": "2025-07-20", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 560954, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-07-21", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 565443, "CTR": 0.0032},
    {"–î–µ–Ω—å": "2025-07-22", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 560722, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-07-23", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 547406, "CTR": 0.0032},
    {"–î–µ–Ω—å": "2025-07-24", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 579756, "CTR": 0.0032},
    {"–î–µ–Ω—å": "2025-07-25", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 546727, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-07-26", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 545462, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-07-27", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 577077, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-07-28", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 580362, "CTR": 0.0032},
    {"–î–µ–Ω—å": "2025-07-29", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 588064, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-07-30", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 581064, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-07-31", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 544739, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-08-01", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 520185, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-08-02", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 501907, "CTR": 0.0039},
    {"–î–µ–Ω—å": "2025-08-03", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 482822, "CTR": 0.0040},
    {"–î–µ–Ω—å": "2025-08-04", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 669837, "CTR": 0.0025},
    {"–î–µ–Ω—å": "2025-08-05", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 576567, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-08-06", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 642780, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-08-07", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 673041, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-08-08", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 566337, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-08-09", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 576441, "CTR": 0.0032},
    {"–î–µ–Ω—å": "2025-08-10", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 535174, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-08-11", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 652811, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-08-12", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 581944, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-08-13", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 574248, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-08-14", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 571454, "CTR": 0.0025},
    {"–î–µ–Ω—å": "2025-08-15", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 609677, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-08-16", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 553333, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-08-17", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 543042, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-08-18", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 593552, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-08-19", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 604993, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-08-20", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 585223, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-08-21", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 565594, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-08-22", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 561710, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-08-23", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 573074, "CTR": 0.0034},
    {"–î–µ–Ω—å": "2025-08-24", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 576296, "CTR": 0.0036},
    {"–î–µ–Ω—å": "2025-08-25", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 639742, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-08-26", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 628276, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-08-27", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 682482, "CTR": 0.0038},
    {"–î–µ–Ω—å": "2025-08-28", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 634092, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-08-29", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 649224, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-08-30", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 618085, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-08-31", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 587591, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-09-01", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 716232, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-09-02", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 639847, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-09-03", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 662381, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-04", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 634538, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-09-05", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 630812, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-06", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 599470, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-09-07", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 631420, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-09-08", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 682262, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-09", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 657384, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-09-10", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 636123, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-09-11", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 648090, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-12", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 609418, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-09-13", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 617821, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-09-14", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 617338, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-09-15", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 672473, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-09-16", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 679641, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-17", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 633946, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-09-18", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 656208, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-19", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 654711, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-09-20", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 637633, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-09-21", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 642665, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-09-22", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 669762, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-23", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 660455, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-09-24", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 672452, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-25", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 660577, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-09-26", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 679489, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-09-27", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 653993, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-09-28", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 635230, "CTR": 0.0033},
    {"–î–µ–Ω—å": "2025-09-29", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 696249, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-09-30", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 652620, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-10-01", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 652261, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-10-02", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 663432, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-10-03", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 642417, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-10-04", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 538845, "CTR": 0.0036},
    {"–î–µ–Ω—å": "2025-10-05", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 564007, "CTR": 0.0035},
    {"–î–µ–Ω—å": "2025-10-06", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 691805, "CTR": 0.0025},
    {"–î–µ–Ω—å": "2025-10-07", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 636792, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-10-08", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 641702, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-10-09", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 658915, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-10-10", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 611511, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-10-11", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 623414, "CTR": 0.0032},
    {"–î–µ–Ω—å": "2025-10-12", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 614969, "CTR": 0.0031},
    {"–î–µ–Ω—å": "2025-10-13", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 656572, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-10-14", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 652482, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-10-15", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 651238, "CTR": 0.0025},
    {"–î–µ–Ω—å": "2025-10-16", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 643982, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-10-17", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 615524, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-10-18", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 632823, "CTR": 0.0030},
    {"–î–µ–Ω—å": "2025-10-19", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 643107, "CTR": 0.0029},
    {"–î–µ–Ω—å": "2025-10-20", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 638985, "CTR": 0.0028},
    {"–î–µ–Ω—å": "2025-10-21", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 614872, "CTR": 0.0025},
    {"–î–µ–Ω—å": "2025-10-22", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 610813, "CTR": 0.0026},
    {"–î–µ–Ω—å": "2025-10-23", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 687987, "CTR": 0.0027},
    {"–î–µ–Ω—å": "2025-10-24", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 603319, "CTR": 0.0024},
    {"–î–µ–Ω—å": "2025-10-25", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 0, "CTR": None},
    {"–î–µ–Ω—å": "2025-10-26", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 0, "CTR": None},
    {"–î–µ–Ω—å": "2025-10-27", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 966724, "CTR": 0.002456},
    {"–î–µ–Ω—å": "2025-10-28", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 587150, "CTR": 0.002381},
    {"–î–µ–Ω—å": "2025-10-29", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã": 316702, "CTR": 0.003499},
]

df_ctr = pd.DataFrame(CTR_DATA)
df_ctr["–î–µ–Ω—å"] = pd.to_datetime(df_ctr["–î–µ–Ω—å"])
df_ctr = df_ctr.sort_values("–î–µ–Ω—å").reset_index(drop=True)

# -----------------------------------------------------
# –°–ü–û–†–¢–°–û–ë–´–¢–ò–Ø
# -----------------------------------------------------
EVENTS = [
    {"–Ω–∞—á–∞–ª–æ": "2025-03-26", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-05-25", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–ü–ª–µ–π-–æ—Ñ—Ñ –ö–•–õ", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–•–æ–∫–∫–µ–π"},
    {"–Ω–∞—á–∞–ª–æ": "2025-04-15", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-06-22", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–ü–ª–µ–π-–æ—Ñ—Ñ –ù–ë–ê", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–ë–∞—Å–∫–µ—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-04-19", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-06-23", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–ü–ª–µ–π-–æ—Ñ—Ñ –ù–•–õ", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–•–æ–∫–∫–µ–π"},
    {"–Ω–∞—á–∞–ª–æ": "2025-04-26", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-04-26", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–≠–ª—å –ö–ª–∞—Å—Å–∏–∫–æ (–∞–ø—Ä–µ–ª—å)", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-05-09", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-05-25", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–ß–µ–º–ø–∏–æ–Ω–∞—Ç –º–∏—Ä–∞ –ø–æ —Ö–æ–∫–∫–µ—é", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–•–æ–∫–∫–µ–π"},
    {"–Ω–∞—á–∞–ª–æ": "2025-05-11", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-05-11", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–≠–ª—å –ö–ª–∞—Å—Å–∏–∫–æ (–º–∞–π)", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-05-24", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-05-24", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π —Ç—É—Ä –†–ü–õ", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-05-25", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-06-07", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–¢–µ–Ω–Ω–∏—Å ¬´–†–æ–ª–∞–Ω –ì–∞—Ä—Ä–æ—Å¬ª", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–¢–µ–Ω–Ω–∏—Å"},
    {"–Ω–∞—á–∞–ª–æ": "2025-05-31", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-05-31", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–§–∏–Ω–∞–ª –õ–∏–≥–∏ —á–µ–º–ø–∏–æ–Ω–æ–≤", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-06-14", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-07-13", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–ö–ª—É–±–Ω—ã–π —á–µ–º–ø–∏–æ–Ω–∞—Ç –º–∏—Ä–∞", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-06-29", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-06-29", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "UFC 317", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "UFC"},
    {"–Ω–∞—á–∞–ª–æ": "2025-06-30", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-07-13", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–¢–µ–Ω–Ω–∏—Å ¬´–£–∏–º–±–ª–¥–æ–Ω¬ª", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–¢–µ–Ω–Ω–∏—Å"},
    {"–Ω–∞—á–∞–ª–æ": "2025-07-18", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-10-29", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–°—Ç–∞—Ä—Ç —Å–µ–∑–æ–Ω–∞ –†–ü–õ", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-08-02", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-10-29", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–°—Ç–∞—Ä—Ç —Å–µ–∑–æ–Ω–∞ –ê–ü–õ", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-08-15", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-10-29", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–°—Ç–∞—Ä—Ç —Å–µ–∑–æ–Ω–∞ –õ–∞ –õ–∏–≥–∏", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-08-17", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-08-17", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "UFC 319", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "UFC"},
    {"–Ω–∞—á–∞–ª–æ": "2025-08-25", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-09-07", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–¢–µ–Ω–Ω–∏—Å US Open", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–¢–µ–Ω–Ω–∏—Å"},
    {"–Ω–∞—á–∞–ª–æ": "2025-08-27", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-09-14", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–ë–∞—Å–∫–µ—Ç–±–æ–ª –ï–≤—Ä–æ-2025 (–ú)", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–ë–∞—Å–∫–µ—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-10-04", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-10-04", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "UFC 320", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "UFC"},
    {"–Ω–∞—á–∞–ª–æ": "2025-10-07", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-10-29", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–°—Ç–∞—Ä—Ç —Å–µ–∑–æ–Ω–∞ –ù–•–õ", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–•–æ–∫–∫–µ–π"},
    {"–Ω–∞—á–∞–ª–æ": "2025-10-21", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-10-29", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–°—Ç–∞—Ä—Ç —Å–µ–∑–æ–Ω–∞ –ù–ë–ê", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–ë–∞—Å–∫–µ—Ç–±–æ–ª"},
    {"–Ω–∞—á–∞–ª–æ": "2025-10-26", "–æ–∫–æ–Ω—á–∞–Ω–∏–µ": "2025-10-26", "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–≠–ª—å –ö–ª–∞—Å—Å–∏–∫–æ (–æ–∫—Ç—è–±—Ä—å)", "–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞": "–§—É—Ç–±–æ–ª"},
]
df_events = pd.DataFrame(EVENTS)
df_events["–Ω–∞—á–∞–ª–æ"] = pd.to_datetime(df_events["–Ω–∞—á–∞–ª–æ"])
df_events["–æ–∫–æ–Ω—á–∞–Ω–∏–µ"] = pd.to_datetime(df_events["–æ–∫–æ–Ω—á–∞–Ω–∏–µ"])

# -----------------------------------------------------
# –í–ò–ó–£–ê–õ–¨–ù–´–ô –°–ï–õ–ï–ö–¢–û–† –°–¢–†–ê–ù–ò–¶
# -----------------------------------------------------
with st.container():
    st.markdown(
        """
        <style>
        .page-pill {
            display:inline-block;
            margin-right:0.5rem;
            margin-bottom:0.4rem;
        }
        </style>
        """,
        unsafe_allow_html=True,
    )
    st.markdown(
        "<div style='margin-bottom:0.4rem;font-weight:500;'>–í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞</div>",
        unsafe_allow_html=True,
    )
    # üü° —Ç—É—Ç –º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫
    page = st.radio(
        "",
        (
            "–ò—Ç–æ–≥–∏",
            "–°–º–µ–Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤",
            "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã",
        ),
        horizontal=True,
        label_visibility="collapsed",
    )

# =====================================================
# 1) –ò–¢–û–ì–ò  (—Ç–µ–ø–µ—Ä—å –ø–µ—Ä–≤—ã–π —Ä–∞–∑–¥–µ–ª)
# =====================================================
if page == "–ò—Ç–æ–≥–∏":
    st.markdown("### –ò—Ç–æ–≥–∏")

    # –≥—Ä–∞–Ω–∏—Ü—ã —ç—Ç–∞–ø–æ–≤
    stage_1_start = pd.to_datetime("2025-04-23")
    stage_2_start = pd.to_datetime("2025-07-07")
    stage_3_start = pd.to_datetime("2025-08-14")
    stage_4_start = pd.to_datetime("2025-10-22")

    # –¥–∞—Ç—ã —Å–º–µ–Ω –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
    stage_switches = [
        pd.to_datetime("2025-07-07"),
        pd.to_datetime("2025-08-14"),
        pd.to_datetime("2025-10-22"),
    ]

    # –≤—Å—è –±–∞–∑–∞ –ø–æ –¥–Ω—è–º
    df_all = df_ctr.dropna(subset=["CTR"]).copy()
    df_all = df_all.sort_values("–î–µ–Ω—å").reset_index(drop=True)

    # –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
    global_views_mean = df_all["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"].mean()

    # --- –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
    def exact_events_for_day(d: pd.Timestamp) -> str:
        names = []
        for _, ev in df_events.iterrows():
            if ev["–Ω–∞—á–∞–ª–æ"].date() == d.date() or ev["–æ–∫–æ–Ω—á–∞–Ω–∏–µ"].date() == d.date():
                names.append(ev["–Ω–∞–∑–≤–∞–Ω–∏–µ"])
        return ", ".join(names)

    def stage_for_day(d: pd.Timestamp) -> int:
        if d < stage_2_start:
            return 1
        elif d < stage_3_start:
            return 2
        elif d < stage_4_start:
            return 3
        else:
            return 4

    def is_stage_switch_near(d: pd.Timestamp) -> str:
        for sw in stage_switches:
            # —Ç–æ–ª—å–∫–æ –≤ 7 –¥–Ω–µ–π –ü–û–°–õ–ï —Å–º–µ–Ω—ã
            if sw < d <= sw + pd.Timedelta(days=7):
                return "–¥–∞"
        return "–Ω–µ—Ç"

    # --- –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è ---
    df_all["–¢–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è"] = df_all["–î–µ–Ω—å"].apply(exact_events_for_day)
    df_all["–≠—Ç–∞–ø"] = df_all["–î–µ–Ω—å"].apply(stage_for_day)
    df_all["–°–º–µ–Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤"] = df_all["–î–µ–Ω—å"].apply(is_stage_switch_near)
    df_all["–î–∞—Ç–∞"] = df_all["–î–µ–Ω—å"].dt.strftime("%d.%m.%Y")
    df_all["CTR (–≤ %)"] = df_all["CTR"].map(lambda x: f"{x:.2%}")

    # –≥–ª–æ–±–∞–ª—å–Ω–æ –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º
    df_all["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ"] = df_all["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"].apply(
        lambda v: "–¥–∞" if v >= global_views_mean else "–Ω–µ—Ç"
    )

    # --- –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ä–µ–¥–Ω–∏–µ (¬±7 –¥–Ω–µ–π) –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∏ CTR ---
    min_day = df_all["–î–µ–Ω—å"].min()
    max_day = df_all["–î–µ–Ω—å"].max()

    local_views_means = []
    local_ctr_means = []
    ctr_local_flags = []
    views_local_flags = []

    for _, row in df_all.iterrows():
        cur_day = row["–î–µ–Ω—å"]
        date_min = max(min_day, cur_day - pd.Timedelta(days=7))
        date_max = min(max_day, cur_day + pd.Timedelta(days=7))

        window = df_all[(df_all["–î–µ–Ω—å"] >= date_min) & (df_all["–î–µ–Ω—å"] <= date_max)]

        # –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
        lv_mean = window["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"].mean()
        local_views_means.append(lv_mean)
        views_local_flags.append("–¥–∞" if row["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"] >= lv_mean else "–Ω–µ—Ç")

        # –ª–æ–∫–∞–ª—å–Ω—ã–π ctr
        lc_mean = window["CTR"].mean()
        local_ctr_means.append(lc_mean)
        ctr_local_flags.append("–¥–∞" if row["CTR"] >= lc_mean else "–Ω–µ—Ç")

    df_all["–õ–æ–∫–∞–ª—å–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"] = local_views_means
    df_all["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ"] = views_local_flags
    df_all["–õ–æ–∫–∞–ª—å–Ω—ã–π CTR"] = local_ctr_means
    df_all["CTR –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ"] = ctr_local_flags
    df_all["–õ–æ–∫–∞–ª—å–Ω—ã–π CTR (–≤ %)"] = df_all["–õ–æ–∫–∞–ª—å–Ω—ã–π CTR"].map(lambda x: f"{x:.2%}")

    # --- –¢–ê–ë–õ–ò–¶–ê 1: –¥–Ω–∏ –ø–æ CTR –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ (¬±7 –¥–Ω–µ–π) ---
    df_table_ctr = df_all[df_all["CTR –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ"] == "–¥–∞"].copy()
    df_table_ctr = df_table_ctr.sort_values("CTR", ascending=False)

    total_peaks = len(df_table_ctr)  # —ç—Ç–æ "–∫–æ–ª-–≤–æ –≤—ã–≤–µ–¥–µ–Ω–Ω—ã—Ö –ø–∏–∫–æ–≤"

    # –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å—á–∏—Ç–∞–µ–º –ø–æ —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ
    events_count = (df_table_ctr["–¢–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è"] != "").sum()
    views_high_global = (df_table_ctr["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ"] == "–¥–∞").sum()
    views_high_local = (df_table_ctr["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ"] == "–¥–∞").sum()
    stage_switch_count = (df_table_ctr["–°–º–µ–Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤"] == "–¥–∞").sum()

    # –≥–æ—Ç–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ -> –ø—Ä–æ—Ü–µ–Ω—Ç
    metrics = []
    def to_pct(count):
        if total_peaks == 0:
            return 0.0
        return (count / total_peaks) * 100.0

    metrics.append({
        "title": "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ (¬±7 –¥–Ω)",
        "value": to_pct(views_high_local),
    })
    metrics.append({
        "title": "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ (–≥–ª–æ–±–∞–ª—å–Ω–æ)",
        "value": to_pct(views_high_global),
    })
    metrics.append({
        "title": "–°–º–µ–Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ (+7 –¥–Ω)",
        "value": to_pct(stage_switch_count),
    })
    metrics.append({
        "title": "–°–æ–±—ã—Ç–∏—è",
        "value": to_pct(events_count),
    })

    # —Å–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
    metrics = sorted(metrics, key=lambda x: x["value"], reverse=True)

    # --- –∫–∞—Ä—Ç–æ—á–∫–∏ ---
    cards_html = "<div style='display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;'>"
    for m in metrics:
        cards_html += f"""
            <div style="background:#1f2937;border:1px solid #374151;border-radius:0.75rem;padding:0.75rem 1rem;min-width:190px;">
                <div style="font-size:0.7rem;color:#9ca3af;">{m['title']}</div>
                <div style="font-size:1.6rem;font-weight:600;">{m['value']:.1f}%</div>
            </div>
        """
    cards_html += "</div>"
    st.markdown(cards_html, unsafe_allow_html=True)

    # --- 1) —Ç–∞–±–ª–∏—Ü–∞ –ø–æ CTR ---
    st.markdown("#### 1) –î–Ω–∏ –ø–æ CTR –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ (¬±7 –¥–Ω–µ–π)")

    cols_ctr = [
        "–î–∞—Ç–∞",
        "CTR (–≤ %)",
        "–õ–æ–∫–∞–ª—å–Ω—ã–π CTR (–≤ %)",
        "–¢–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è",
        "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ",
        "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ",
        "–≠—Ç–∞–ø",
        "–°–º–µ–Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤",
    ]
    cols_ctr = [c for c in cols_ctr if c in df_table_ctr.columns]

    st.dataframe(
        df_table_ctr[cols_ctr],
        use_container_width=True,
        hide_index=True,
    )
    st.markdown(f"**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:** {len(df_table_ctr)}")

    # --- 2) –≤—Å–µ –¥–Ω–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é CTR ---
    st.markdown("#### 2) –í—Å–µ –¥–Ω–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é CTR")

    df_table_all = df_all.sort_values("CTR", ascending=False)
    cols_all = [
        "–î–∞—Ç–∞",
        "CTR (–≤ %)",
        "–õ–æ–∫–∞–ª—å–Ω—ã–π CTR (–≤ %)",
        "–¢–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è",
        "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ",
        "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤—ã—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ",
        "–≠—Ç–∞–ø",
        "–°–º–µ–Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤",
    ]
    cols_all = [c for c in cols_all if c in df_table_all.columns]

    st.dataframe(
        df_table_all[cols_all],
        use_container_width=True,
        hide_index=True,
    )

    # –æ–±—â–∞—è —Å—Ç—Ä–æ–∫–∞ –≤–Ω–∏–∑—É
    st.markdown(
        "<div style='margin-top:1.5rem;color:#9ca3af;'>–ù–∞–ª–∏—á–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∞ –≤ –¥–µ–Ω—å –ø–∏–∫–æ–≤–æ–≥–æ CTR –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 14 –¥–Ω–µ–π</div>",
        unsafe_allow_html=True,
    )

# =====================================================
# 2) –°–ú–ï–ù–ê –ö–†–ï–ê–¢–ò–í–û–í
# =====================================================
elif page == "–°–º–µ–Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤":
    st.markdown("### CTR –ø–æ —ç—Ç–∞–ø–∞–º –∫–∞–º–ø–∞–Ω–∏–∏ (—Å–º–µ–Ω—ã –∫—Ä–µ–∞—Ç–∏–≤–æ–≤)")

    b1 = pd.to_datetime("2025-04-23")
    b2 = pd.to_datetime("2025-07-07")
    b3 = pd.to_datetime("2025-08-14")
    b4 = pd.to_datetime("2025-10-22")
    b5 = pd.to_datetime("2025-10-29")

    df2 = df_ctr.dropna(subset=["CTR"]).copy()

    fig2 = go.Figure()

    seg1 = df2[(df2["–î–µ–Ω—å"] >= b1) & (df2["–î–µ–Ω—å"] < b2)]
    fig2.add_trace(
        go.Scatter(
            x=seg1["–î–µ–Ω—å"],
            y=seg1["CTR"],
            mode="lines+markers",
            name="23.04 ‚Äì 07.07",
            line=dict(color="rgba(141,181,255,1)", width=2.2),
            marker=dict(size=4),
            hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
        )
    )

    seg2 = df2[(df2["–î–µ–Ω—å"] >= b2) & (df2["–î–µ–Ω—å"] < b3)]
    fig2.add_trace(
        go.Scatter(
            x=seg2["–î–µ–Ω—å"],
            y=seg2["CTR"],
            mode="lines+markers",
            name="07.07 ‚Äì 14.08",
            line=dict(color="rgba(102,204,153,1)", width=2.2),
            marker=dict(size=4),
            hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
        )
    )

    seg3 = df2[(df2["–î–µ–Ω—å"] >= b3) & (df2["–î–µ–Ω—å"] < b4)]
    fig2.add_trace(
        go.Scatter(
            x=seg3["–î–µ–Ω—å"],
            y=seg3["CTR"],
            mode="lines+markers",
            name="14.08 ‚Äì 22.10",
            line=dict(color="rgba(255,159,67,1)", width=2.2),
            marker=dict(size=4),
            hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
        )
    )

    seg4 = df2[(df2["–î–µ–Ω—å"] >= b4) & (df2["–î–µ–Ω—å"] <= b5)]
    fig2.add_trace(
        go.Scatter(
            x=seg4["–î–µ–Ω—å"],
            y=seg4["CTR"],
            mode="lines+markers",
            name="22.10 ‚Äì 29.10",
            line=dict(color="rgba(255,221,87,1)", width=2.2),
            marker=dict(size=4),
            hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
        )
    )

    fig2.update_layout(
        height=520,
        margin=dict(l=20, r=20, t=40, b=40),
        xaxis_title="–î–∞—Ç–∞",
        yaxis_title="CTR",
        hovermode="x unified",
        plot_bgcolor="rgba(0,0,0,0)",
        paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    fig2.update_yaxes(tickformat=".2%")
    st.plotly_chart(fig2, use_container_width=True)

    def make_window(df, center_date, days=3):
        win = df[(df["–î–µ–Ω—å"] >= center_date - pd.Timedelta(days=days)) &
                 (df["–î–µ–Ω—å"] <= center_date + pd.Timedelta(days=days))].copy()
        win["–î–∞—Ç–∞"] = win["–î–µ–Ω—å"].dt.strftime("%d.%m.%Y")
        win["CTR (–≤ %)"] = win["CTR"].map(lambda x: f"{x:.2%}")
        return win[["–î–∞—Ç–∞", "CTR (–≤ %)"]]

    def render_small_table(df_table, title, highlight_date, color_hex):
        st.markdown(f"**{title}**")
        html = "<table style='width:100%;max-width:260px;border-collapse:collapse;font-size:0.85rem;'>"
        html += (
            "<tr>"
            "<th style='text-align:left;padding:4px 6px;border-bottom:1px solid #555;'>–î–∞—Ç–∞</th>"
            "<th style='text-align:right;padding:4px 6px;border-bottom:1px solid #555;'>CTR</th>"
            "</tr>"
        )
        target_str = highlight_date.strftime("%d.%m.%Y")
        for _, row in df_table.iterrows():
            bg = ""
            if row["–î–∞—Ç–∞"] == target_str:
                bg = f"background-color:{color_hex};"
            html += (
                f"<tr style='{bg}'>"
                f"<td style='padding:3px 6px;'>{row['–î–∞—Ç–∞']}</td>"
                f"<td style='padding:3px 6px;text-align:right;'>{row['CTR (–≤ %)']}</td>"
                f"</tr>"
            )
        html += "</table>"
        st.markdown(html, unsafe_allow_html=True)

    win_b1 = make_window(df2, b1, 3)
    win_b2 = make_window(df2, b2, 3)
    win_b3 = make_window(df2, b3, 3)
    win_b4 = make_window(df2, b4, 3)

    c1, c2, c3, c4 = st.columns(4)
    with c1:
        render_small_table(win_b1, "1 –§–õ–ê–ô–¢", b1, "#8DB5FF55")
    with c2:
        render_small_table(win_b2, "2 –§–õ–ê–ô–¢", b2, "#66CC9955")
    with c3:
        render_small_table(win_b3, "3 –§–õ–ê–ô–¢", b3, "#FF9F4355")
    with c4:
        render_small_table(win_b4, "4 –§–õ–ê–ô–¢", b4, "#FFDD5755")

# =====================================================
# 3) –°–ü–û–†–¢–ò–í–ù–´–ï –°–û–ë–´–¢–ò–Ø
# =====================================================
elif page == "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è":
    min_date = pd.to_datetime("2025-04-23")
    max_date = df_ctr["–î–µ–Ω—å"].max()

    st.markdown(
        "<div style='text-align:center;margin-top:0.5rem;margin-bottom:0.5rem;'><b>–§–∏–ª—å—Ç—Ä—ã</b></div>",
        unsafe_allow_html=True,
    )
    col_l, col_c, col_r = st.columns([1, 2.5, 1])
    with col_c:
        date_from, date_to = st.slider(
            "–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç",
            min_value=min_date.to_pydatetime(),
            max_value=max_date.to_pydatetime(),
            value=(min_date.to_pydatetime(), max_date.to_pydatetime()),
            format="DD.MM.YYYY",
        )
        top_n = st.number_input(
            "–ü–∏–∫–æ–≤ CTR –≤—ã–≤–µ—Å—Ç–∏",
            min_value=3,
            max_value=50,
            value=15,
            step=1,
        )

    date_from = pd.to_datetime(date_from)
    date_to = pd.to_datetime(date_to)

    df_view = df_ctr[(df_ctr["–î–µ–Ω—å"] >= date_from) & (df_ctr["–î–µ–Ω—å"] <= date_to)].copy()
    df_view = df_view.dropna(subset=["CTR"]).sort_values("–î–µ–Ω—å")

    def exact_events_for_day(d: pd.Timestamp) -> str:
        names = []
        for _, ev in df_events.iterrows():
            if ev["–Ω–∞—á–∞–ª–æ"].date() == d.date() or ev["–æ–∫–æ–Ω—á–∞–Ω–∏–µ"].date() == d.date():
                names.append(ev["–Ω–∞–∑–≤–∞–Ω–∏–µ"])
        return ", ".join(names)

    def interval_events_for_day(d: pd.Timestamp) -> str:
        names = []
        for _, ev in df_events.iterrows():
            if ev["–Ω–∞—á–∞–ª–æ"] <= d <= ev["–æ–∫–æ–Ω—á–∞–Ω–∏–µ"]:
                names.append(ev["–Ω–∞–∑–≤–∞–Ω–∏–µ"])
        return ", ".join(names)

    df_view["CTR_prev"] = df_view["CTR"].shift(1)
    df_view["CTR_change"] = (df_view["CTR"] - df_view["CTR_prev"]) / df_view["CTR_prev"]
    df_view["–°–æ–±—ã—Ç–∏–µ (—Ç–æ—á–Ω–æ–µ)"] = df_view["–î–µ–Ω—å"].apply(exact_events_for_day)

    CTR_EVENT_THR = 0.12

    def is_dependent(row):
        if not row["–°–æ–±—ã—Ç–∏–µ (—Ç–æ—á–Ω–æ–µ)"]:
            return False
        if pd.isna(row["CTR_change"]):
            return False
        return abs(row["CTR_change"]) >= CTR_EVENT_THR

    df_view["dependent_move"] = df_view.apply(is_dependent, axis=1)
    dependent_count = int(df_view["dependent_move"].sum())

    sport_colors = {
        "–•–æ–∫–∫–µ–π": "rgba(46, 204, 113, 0.12)",
        "–ë–∞—Å–∫–µ—Ç–±–æ–ª": "rgba(52, 152, 219, 0.12)",
        "–§—É—Ç–±–æ–ª": "rgba(231, 76, 60, 0.12)",
        "–¢–µ–Ω–Ω–∏—Å": "rgba(155, 89, 182, 0.12)",
        "UFC": "rgba(241, 196, 15, 0.12)",
    }

    fig = go.Figure()
    fig.add_trace(
        go.Scatter(
            x=df_view["–î–µ–Ω—å"],
            y=df_view["CTR"],
            mode="lines+markers",
            name="CTR",
            line=dict(width=2.2, color="rgba(181, 220, 255, 1)"),
            marker=dict(size=4),
            hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
        )
    )

    for _, ev in df_events.iterrows():
        if ev["–æ–∫–æ–Ω—á–∞–Ω–∏–µ"] < date_from or ev["–Ω–∞—á–∞–ª–æ"] > date_to:
            continue
        x0 = max(ev["–Ω–∞—á–∞–ª–æ"], date_from)
        x1 = min(ev["–æ–∫–æ–Ω—á–∞–Ω–∏–µ"], date_to)
        fill = sport_colors.get(ev["–≤–∏–¥ —Å–ø–æ—Ä—Ç–∞"], "rgba(255,255,255,0.05)")

        fig.add_vrect(
            x0=x0,
            x1=x1,
            fillcolor=fill,
            layer="below",
            line_width=0,
        )
        fig.add_vline(
            x=ev["–Ω–∞—á–∞–ª–æ"],
            line_width=0.8,
            line_dash="dash",
            line_color="rgba(255,255,255,0.4)",
        )
        fig.add_annotation(
            x=x0,
            y=1.03,
            xref="x",
            yref="paper",
            text=ev["–Ω–∞–∑–≤–∞–Ω–∏–µ"],
            showarrow=False,
            xanchor="left",
            font=dict(size=10, color="#ffffff"),
            textangle=65,
        )

    fig.update_layout(
        height=560,
        margin=dict(l=20, r=20, t=90, b=40),
        xaxis_title="–î–∞—Ç–∞",
        yaxis_title="CTR",
        hovermode="x unified",
        plot_bgcolor="rgba(0,0,0,0)",
        paper_bgcolor="rgba(0,0,0,0)",
    )
    fig.update_xaxes(range=[date_from, date_to], showgrid=False)
    fig.update_yaxes(showgrid=True, zeroline=False, tickformat=".2%")

    st.plotly_chart(fig, use_container_width=True)

    st.markdown(
        f"**–ó–∞–≤–∏—Å–∏–º—ã—Ö —Å–¥–≤–∏–≥–æ–≤:** {dependent_count}"
    )

    peaks = df_view.sort_values("CTR", ascending=False).head(top_n).copy()
    peaks["–î–∞—Ç–∞"] = peaks["–î–µ–Ω—å"].dt.strftime("%d.%m.%Y")
    peaks["CTR (–≤ %)"] = peaks["CTR"].map(lambda x: f"{x:.2%}")
    peaks["–°–æ–±—ã—Ç–∏–µ (—Ç–æ—á–Ω–æ–µ)"] = peaks["–î–µ–Ω—å"].apply(exact_events_for_day)
    peaks["–°–æ–±—ã—Ç–∏—è (–≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ)"] = peaks["–î–µ–Ω—å"].apply(interval_events_for_day)

    st.markdown("### –ü–∏–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è CTR")
    st.dataframe(
        peaks[["–î–∞—Ç–∞", "CTR (–≤ %)", "–°–æ–±—ã—Ç–∏–µ (—Ç–æ—á–Ω–æ–µ)", "–°–æ–±—ã—Ç–∏—è (–≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ)"]],
        use_container_width=True,
        hide_index=True,
    )

# =====================================================
# 4) –ü–†–û–°–ú–û–¢–†–´
# =====================================================
else:  # "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"
    st.markdown("### CTR vs –ü—Ä–æ—Å–º–æ—Ç—Ä—ã (–ø–æ –¥–Ω—è–º)")

    min_date = pd.to_datetime("2025-04-23")
    max_date = df_ctr["–î–µ–Ω—å"].max()

    st.markdown(
        "<div style='text-align:center;margin-top:0.5rem;margin-bottom:0.5rem;'><b>–§–∏–ª—å—Ç—Ä—ã</b></div>",
        unsafe_allow_html=True,
    )

    col_l, col_c, col_r = st.columns([1, 2.5, 1])
    with col_c:
        date_from, date_to = st.slider(
            "–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç",
            min_value=min_date.to_pydatetime(),
            max_value=max_date.to_pydatetime(),
            value=(min_date.to_pydatetime(), max_date.to_pydatetime()),
            format="DD.MM.YYYY",
        )
        top_n = st.number_input(
            "–ü–∏–∫–æ–≤ CTR –≤—ã–≤–µ—Å—Ç–∏",
            min_value=3,
            max_value=50,
            value=15,
            step=1,
        )

    date_from = pd.to_datetime(date_from)
    date_to = pd.to_datetime(date_to)

    df3 = df_ctr[(df_ctr["–î–µ–Ω—å"] >= date_from) & (df_ctr["–î–µ–Ω—å"] <= date_to)].copy()
    df3 = df3.dropna(subset=["CTR"]).sort_values("–î–µ–Ω—å")

    df3["CTR_prev"] = df3["CTR"].shift(1)
    df3["Views_prev"] = df3["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"].shift(1)
    df3["CTR_change"] = (df3["CTR"] - df3["CTR_prev"]) / df3["CTR_prev"]
    df3["Views_change"] = (df3["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"] - df3["Views_prev"]) / df3["Views_prev"]

    CTR_THR = 0.12
    VIEWS_THR = 0.12

    def is_joint3(row):
        if pd.isna(row["CTR_change"]) or pd.isna(row["Views_change"]):
            return False
        if row["CTR_change"] > CTR_THR and row["Views_change"] > VIEWS_THR:
            return True
        if row["CTR_change"] < -CTR_THR and row["Views_change"] < -VIEWS_THR:
            return True
        return False

    df3["joint_move"] = df3.apply(is_joint3, axis=1)
    joint_days = df3[df3["joint_move"]]

    fig3 = go.Figure()

    fig3.add_trace(
        go.Scatter(
            x=df3["–î–µ–Ω—å"],
            y=df3["CTR"],
            mode="lines+markers",
            name="CTR",
            line=dict(color="rgba(102,178,255,1)", width=2.2),
            marker=dict(size=4),
            hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
            yaxis="y1",
        )
    )

    fig3.add_trace(
        go.Scatter(
            x=df3["–î–µ–Ω—å"],
            y=df3["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"],
            mode="lines+markers",
            name="–ü—Ä–æ—Å–º–æ—Ç—Ä—ã",
            line=dict(color="rgba(255,159,67,1)", width=2.0),
            marker=dict(size=3),
            hovertemplate="%{x|%d.%m.%Y}<br>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã: %{y:,}<extra></extra>",
            yaxis="y2",
        )
    )

    for _, row in joint_days.iterrows():
        fig3.add_vline(
            x=row["–î–µ–Ω—å"],
            line_width=1.1,
            line_dash="dot",
            line_color="rgba(255,80,80,0.85)",
        )

    fig3.update_layout(
        height=560,
        margin=dict(l=20, r=20, t=40, b=40),
        xaxis=dict(
            title="–î–∞—Ç–∞",
            range=[date_from, date_to],
            showgrid=False,
        ),
        yaxis=dict(
            title="CTR",
            showgrid=True,
            zeroline=False,
            tickformat=".2%",
        ),
        yaxis2=dict(
            title="–ü—Ä–æ—Å–º–æ—Ç—Ä—ã",
            overlaying="y",
            side="right",
            showgrid=False,
        ),
        hovermode="x unified",
        plot_bgcolor="rgba(0,0,0,0)",
        paper_bgcolor="rgba(0,0,0,0)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )

    st.plotly_chart(fig3, use_container_width=True)

    st.markdown(
        f"**–°–æ–≤–º–µ—Å—Ç–Ω—ã—Ö —Å–∏–ª—å–Ω—ã—Ö –¥–≤–∏–∂–µ–Ω–∏–π (CTR –∏ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã –≤–º–µ—Å—Ç–µ):** {len(joint_days)}"
    )

    avg_views = df3["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"].mean()
    peaks3 = df3.sort_values("CTR", ascending=False).head(top_n).copy()
    peaks3["–î–∞—Ç–∞"] = peaks3["–î–µ–Ω—å"].dt.strftime("%d.%m.%Y")
    peaks3["CTR (–≤ %)"] = peaks3["CTR"].map(lambda x: f"{x:.2%}")
    peaks3["–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"] = peaks3["–ü—Ä–æ—Å–º–æ—Ç—Ä—ã"].apply(
        lambda v: "–≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ" if v >= avg_views else "–Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ"
    )

    st.markdown("### –ü–∏–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è CTR –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥")
    st.dataframe(
        peaks3[["–î–∞—Ç–∞", "CTR (–≤ %)", "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã", "–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"]],
        use_container_width=True,
        hide_index=True,
    )


