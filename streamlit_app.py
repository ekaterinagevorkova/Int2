import streamlit as st
import pandas as pd
import plotly.graph_objects as go
from datetime import datetime

# =========================================================
# 0. НАСТРОЙКА СТРАНИЦЫ
# =========================================================
st.set_page_config(page_title="CTR по дням", layout="wide")
st.title("CTR по дням с наложением спортивных событий")

# =========================================================
# 1. ДАННЫЕ (ВШИТЫ)
# =========================================================
# 1.1. CTR ПО ДНЯМ
# ВНИМАНИЕ: CTR в ДОЛЯХ (0.0034 = 0,34%)
CTR_DATA = [
    {"День": "2025-04-23", "Просмотры": 265237, "CTR": 0.0054},
    {"День": "2025-04-24", "Просмотры": 426884, "CTR": 0.0051},
    {"День": "2025-04-25", "Просмотры": 413081, "CTR": 0.0049},
    {"День": "2025-04-26", "Просмотры": 481718, "CTR": 0.0069},
    {"День": "2025-04-27", "Просмотры": 623013, "CTR": 0.0064},
    {"День": "2025-04-28", "Просмотры": 472590, "CTR": 0.0050},
    {"День": "2025-04-29", "Просмотры": 500183, "CTR": 0.0048},
    {"День": "2025-04-30", "Просмотры": 517238, "CTR": 0.0042},
    {"День": "2025-05-01", "Просмотры": 244971, "CTR": 0.0036},
    {"День": "2025-05-02", "Просмотры": 371701, "CTR": 0.0038},
    {"День": "2025-05-03", "Просмотры": 437894, "CTR": 0.0029},
    {"День": "2025-05-04", "Просмотры": 561845, "CTR": 0.0049},
    {"День": "2025-05-05", "Просмотры": 476233, "CTR": 0.0034},
    {"День": "2025-05-06", "Просмотры": 471161, "CTR": 0.0037},
    {"День": "2025-05-07", "Просмотры": 471216, "CTR": 0.0040},
    {"День": "2025-05-08", "Просмотры": 485460, "CTR": 0.0037},
    {"День": "2025-05-09", "Просмотры": 422336, "CTR": 0.0030},
    {"День": "2025-05-10", "Просмотры": 454709, "CTR": 0.0039},
    {"День": "2025-05-11", "Просмотры": 558409, "CTR": 0.0037},
    {"День": "2025-05-12", "Просмотры": 565616, "CTR": 0.0034},
    {"День": "2025-05-13", "Просмотры": 547357, "CTR": 0.0030},
    {"День": "2025-05-14", "Просмотры": 526545, "CTR": 0.0033},
    {"День": "2025-05-15", "Просмотры": 535184, "CTR": 0.0038},
    {"День": "2025-05-16", "Просмотры": 516963, "CTR": 0.0031},
    {"День": "2025-05-17", "Просмотры": 500540, "CTR": 0.0037},
    {"День": "2025-05-18", "Просмотры": 462166, "CTR": 0.0049},
    {"День": "2025-05-19", "Просмотры": 538880, "CTR": 0.0037},
    {"День": "2025-05-20", "Просмотры": 541629, "CTR": 0.0036},
    {"День": "2025-05-21", "Просмотры": 527592, "CTR": 0.0035},
    {"День": "2025-05-22", "Просмотры": 460450, "CTR": 0.0035},
    {"День": "2025-05-23", "Просмотры": 467756, "CTR": 0.0031},
    {"День": "2025-05-24", "Просмотры": 534840, "CTR": 0.0035},
    {"День": "2025-05-25", "Просмотры": 506351, "CTR": 0.0035},
    {"День": "2025-05-26", "Просмотры": 522780, "CTR": 0.0030},
    {"День": "2025-05-27", "Просмотры": 478067, "CTR": 0.0033},
    {"День": "2025-05-28", "Просмотры": 509517, "CTR": 0.0031},
    {"День": "2025-05-29", "Просмотры": 531466, "CTR": 0.0034},
    {"День": "2025-05-30", "Просмотры": 524913, "CTR": 0.0029},
    {"День": "2025-05-31", "Просмотры": 462039, "CTR": 0.0040},
    {"День": "2025-06-01", "Просмотры": 465341, "CTR": 0.0044},
    {"День": "2025-06-02", "Просмотры": 535146, "CTR": 0.0033},
    {"День": "2025-06-03", "Просмотры": 560600, "CTR": 0.0035},
    {"День": "2025-06-04", "Просмотры": 559671, "CTR": 0.0031},
    {"День": "2025-06-05", "Просмотры": 575665, "CTR": 0.0031},
    {"День": "2025-06-06", "Просмотры": 561396, "CTR": 0.0034},
    {"День": "2025-06-07", "Просмотры": 465010, "CTR": 0.0046},
    {"День": "2025-06-08", "Просмотры": 508173, "CTR": 0.0041},
    {"День": "2025-06-09", "Просмотры": 567428, "CTR": 0.0034},
    {"День": "2025-06-10", "Просмотры": 531868, "CTR": 0.0031},
    {"День": "2025-06-11", "Просмотры": 523310, "CTR": 0.0034},
    {"День": "2025-06-12", "Просмотры": 469664, "CTR": 0.0042},
    {"День": "2025-06-13", "Просмотры": 502609, "CTR": 0.0034},
    {"День": "2025-06-14", "Просмотры": 472580, "CTR": 0.0044},
    {"День": "2025-06-15", "Просмотры": 525757, "CTR": 0.0043},
    {"День": "2025-06-16", "Просмотры": 591741, "CTR": 0.0034},
    {"День": "2025-06-17", "Просмотры": 558300, "CTR": 0.0030},
    {"День": "2025-06-18", "Просмотры": 619877, "CTR": 0.0027},
    {"День": "2025-06-19", "Просмотры": 504746, "CTR": 0.0029},
    {"День": "2025-06-20", "Просмотры": 507177, "CTR": 0.0031},
    {"День": "2025-06-21", "Просмотры": 529465, "CTR": 0.0038},
    {"День": "2025-06-22", "Просмотры": 557972, "CTR": 0.0036},
    {"День": "2025-06-23", "Просмотры": 720505, "CTR": 0.0029},
    {"День": "2025-06-24", "Просмотры": 557098, "CTR": 0.0030},
    {"День": "2025-06-25", "Просмотры": 553033, "CTR": 0.0031},
    {"День": "2025-06-26", "Просмотры": 542082, "CTR": 0.0029},
    {"День": "2025-06-27", "Просмотры": 555067, "CTR": 0.0028},
    {"День": "2025-06-28", "Просмотры": 541955, "CTR": 0.0037},
    {"День": "2025-06-29", "Просмотры": 559450, "CTR": 0.0035},
    {"День": "2025-06-30", "Просмотры": 571918, "CTR": 0.0028},
    {"День": "2025-07-01", "Просмотры": 542226, "CTR": 0.0033},
    {"День": "2025-07-02", "Просмотры": 550525, "CTR": 0.0031},
    {"День": "2025-07-03", "Просмотры": 538977, "CTR": 0.0034},
    {"День": "2025-07-04", "Просмотры": 559607, "CTR": 0.0031},
    {"День": "2025-07-05", "Просмотры": 546075, "CTR": 0.0037},
    {"День": "2025-07-06", "Просмотры": 556872, "CTR": 0.0035},
    {"День": "2025-07-07", "Просмотры": 559247, "CTR": 0.0033},
    {"День": "2025-07-08", "Просмотры": 550701, "CTR": 0.0030},
    {"День": "2025-07-09", "Просмотры": 546590, "CTR": 0.0031},
    {"День": "2025-07-10", "Просмотры": 538504, "CTR": 0.0031},
    {"День": "2025-07-11", "Просмотры": 547488, "CTR": 0.0032},
    {"День": "2025-07-12", "Просмотры": 518794, "CTR": 0.0036},
    {"День": "2025-07-13", "Просмотры": 532777, "CTR": 0.0033},
    {"День": "2025-07-14", "Просмотры": 566576, "CTR": 0.0033},
    {"День": "2025-07-15", "Просмотры": 553796, "CTR": 0.0030},
    {"День": "2025-07-16", "Просмотры": 551008, "CTR": 0.0030},
    {"День": "2025-07-17", "Просмотры": 557916, "CTR": 0.0031},
    {"День": "2025-07-18", "Просмотры": 543210, "CTR": 0.0032},
    {"День": "2025-07-19", "Просмотры": 534881, "CTR": 0.0037},
    {"День": "2025-07-20", "Просмотры": 560954, "CTR": 0.0033},
    {"День": "2025-07-21", "Просмотры": 565443, "CTR": 0.0032},
    {"День": "2025-07-22", "Просмотры": 560722, "CTR": 0.0030},
    {"День": "2025-07-23", "Просмотры": 547406, "CTR": 0.0032},
    {"День": "2025-07-24", "Просмотры": 579756, "CTR": 0.0032},
    {"День": "2025-07-25", "Просмотры": 546727, "CTR": 0.0033},
    {"День": "2025-07-26", "Просмотры": 545462, "CTR": 0.0033},
    {"День": "2025-07-27", "Просмотры": 577077, "CTR": 0.0034},
    {"День": "2025-07-28", "Просмотры": 580362, "CTR": 0.0032},
    {"День": "2025-07-29", "Просмотры": 588064, "CTR": 0.0031},
    {"День": "2025-07-30", "Просмотры": 581064, "CTR": 0.0031},
    {"День": "2025-07-31", "Просмотры": 544739, "CTR": 0.0035},
    {"День": "2025-08-01", "Просмотры": 520185, "CTR": 0.0035},
    {"День": "2025-08-02", "Просмотры": 501907, "CTR": 0.0039},
    {"День": "2025-08-03", "Просмотры": 482822, "CTR": 0.0040},
    {"День": "2025-08-04", "Просмотры": 669837, "CTR": 0.0025},
    {"День": "2025-08-05", "Просмотры": 576567, "CTR": 0.0027},
    {"День": "2025-08-06", "Просмотры": 642780, "CTR": 0.0028},
    {"День": "2025-08-07", "Просмотры": 673041, "CTR": 0.0029},
    {"День": "2025-08-08", "Просмотры": 566337, "CTR": 0.0026},
    {"День": "2025-08-09", "Просмотры": 576441, "CTR": 0.0032},
    {"День": "2025-08-10", "Просмотры": 535174, "CTR": 0.0035},
    {"День": "2025-08-11", "Просмотры": 652811, "CTR": 0.0028},
    {"День": "2025-08-12", "Просмотры": 581944, "CTR": 0.0030},
    {"День": "2025-08-13", "Просмотры": 574248, "CTR": 0.0027},
    {"День": "2025-08-14", "Просмотры": 571454, "CTR": 0.0025},
    {"День": "2025-08-15", "Просмотры": 609677, "CTR": 0.0026},
    {"День": "2025-08-16", "Просмотры": 553333, "CTR": 0.0034},
    {"День": "2025-08-17", "Просмотры": 543042, "CTR": 0.0033},
    {"День": "2025-08-18", "Просмотры": 593552, "CTR": 0.0030},
    {"День": "2025-08-19", "Просмотры": 604993, "CTR": 0.0029},
    {"День": "2025-08-20", "Просмотры": 585223, "CTR": 0.0029},
    {"День": "2025-08-21", "Просмотры": 565594, "CTR": 0.0031},
    {"День": "2025-08-22", "Просмотры": 561710, "CTR": 0.0031},
    {"День": "2025-08-23", "Просмотры": 573074, "CTR": 0.0034},
    {"День": "2025-08-24", "Просмотры": 576296, "CTR": 0.0036},
    {"День": "2025-08-25", "Просмотры": 639742, "CTR": 0.0030},
    {"День": "2025-08-26", "Просмотры": 628276, "CTR": 0.0028},
    {"День": "2025-08-27", "Просмотры": 682482, "CTR": 0.0038},
    {"День": "2025-08-28", "Просмотры": 634092, "CTR": 0.0030},
    {"День": "2025-08-29", "Просмотры": 649224, "CTR": 0.0028},
    {"День": "2025-08-30", "Просмотры": 618085, "CTR": 0.0030},
    {"День": "2025-08-31", "Просмотры": 587591, "CTR": 0.0031},
    {"День": "2025-09-01", "Просмотры": 716232, "CTR": 0.0028},
    {"День": "2025-09-02", "Просмотры": 639847, "CTR": 0.0029},
    {"День": "2025-09-03", "Просмотры": 662381, "CTR": 0.0027},
    {"День": "2025-09-04", "Просмотры": 634538, "CTR": 0.0029},
    {"День": "2025-09-05", "Просмотры": 630812, "CTR": 0.0027},
    {"День": "2025-09-06", "Просмотры": 599470, "CTR": 0.0031},
    {"День": "2025-09-07", "Просмотры": 631420, "CTR": 0.0033},
    {"День": "2025-09-08", "Просмотры": 682262, "CTR": 0.0027},
    {"День": "2025-09-09", "Просмотры": 657384, "CTR": 0.0028},
    {"День": "2025-09-10", "Просмотры": 636123, "CTR": 0.0026},
    {"День": "2025-09-11", "Просмотры": 648090, "CTR": 0.0027},
    {"День": "2025-09-12", "Просмотры": 609418, "CTR": 0.0029},
    {"День": "2025-09-13", "Просмотры": 617821, "CTR": 0.0035},
    {"День": "2025-09-14", "Просмотры": 617338, "CTR": 0.0033},
    {"День": "2025-09-15", "Просмотры": 672473, "CTR": 0.0029},
    {"День": "2025-09-16", "Просмотры": 679641, "CTR": 0.0027},
    {"День": "2025-09-17", "Просмотры": 633946, "CTR": 0.0029},
    {"День": "2025-09-18", "Просмотры": 656208, "CTR": 0.0027},
    {"День": "2025-09-19", "Просмотры": 654711, "CTR": 0.0028},
    {"День": "2025-09-20", "Просмотры": 637633, "CTR": 0.0033},
    {"День": "2025-09-21", "Просмотры": 642665, "CTR": 0.0031},
    {"День": "2025-09-22", "Просмотры": 669762, "CTR": 0.0027},
    {"День": "2025-09-23", "Просмотры": 660455, "CTR": 0.0030},
    {"День": "2025-09-24", "Просмотры": 672452, "CTR": 0.0027},
    {"День": "2025-09-25", "Просмотры": 660577, "CTR": 0.0027},
    {"День": "2025-09-26", "Просмотры": 679489, "CTR": 0.0026},
    {"День": "2025-09-27", "Просмотры": 653993, "CTR": 0.0031},
    {"День": "2025-09-28", "Просмотры": 635230, "CTR": 0.0033},
    {"День": "2025-09-29", "Просмотры": 696249, "CTR": 0.0026},
    {"День": "2025-09-30", "Просмотры": 652620, "CTR": 0.0026},
    {"День": "2025-10-01", "Просмотры": 652261, "CTR": 0.0026},
    {"День": "2025-10-02", "Просмотры": 663432, "CTR": 0.0026},
    {"День": "2025-10-03", "Просмотры": 642417, "CTR": 0.0028},
    {"День": "2025-10-04", "Просмотры": 538845, "CTR": 0.0036},
    {"День": "2025-10-05", "Просмотры": 564007, "CTR": 0.0035},
    {"День": "2025-10-06", "Просмотры": 691805, "CTR": 0.0025},
    {"День": "2025-10-07", "Просмотры": 636792, "CTR": 0.0026},
    {"День": "2025-10-08", "Просмотры": 641702, "CTR": 0.0027},
    {"День": "2025-10-09", "Просмотры": 658915, "CTR": 0.0026},
    {"День": "2025-10-10", "Просмотры": 611511, "CTR": 0.0028},
    {"День": "2025-10-11", "Просмотры": 623414, "CTR": 0.0032},
    {"День": "2025-10-12", "Просмотры": 614969, "CTR": 0.0031},
    {"День": "2025-10-13", "Просмотры": 656572, "CTR": 0.0027},
    {"День": "2025-10-14", "Просмотры": 652482, "CTR": 0.0026},
    {"День": "2025-10-15", "Просмотры": 651238, "CTR": 0.0025},
    {"День": "2025-10-16", "Просмотры": 643982, "CTR": 0.0027},
    {"День": "2025-10-17", "Просмотры": 615524, "CTR": 0.0029},
    {"День": "2025-10-18", "Просмотры": 632823, "CTR": 0.0030},
    {"День": "2025-10-19", "Просмотры": 643107, "CTR": 0.0029},
    {"День": "2025-10-20", "Просмотры": 638985, "CTR": 0.0028},
    {"День": "2025-10-21", "Просмотры": 614872, "CTR": 0.0025},
    {"День": "2025-10-22", "Просмотры": 610813, "CTR": 0.0026},
    {"День": "2025-10-23", "Просмотры": 687987, "CTR": 0.0027},
    {"День": "2025-10-24", "Просмотры": 603319, "CTR": 0.0024},
    {"День": "2025-10-25", "Просмотры": 0, "CTR": None},
    {"День": "2025-10-26", "Просмотры": 0, "CTR": None},
    {"День": "2025-10-27", "Просмотры": 966724, "CTR": 0.002456},
    {"День": "2025-10-28", "Просмотры": 587150, "CTR": 0.002381},
    {"День": "2025-10-29", "Просмотры": 316702, "CTR": 0.003499},
]

df_ctr = pd.DataFrame(CTR_DATA)
df_ctr["День"] = pd.to_datetime(df_ctr["День"])
df_ctr = df_ctr.sort_values("День").reset_index(drop=True)

# 1.2. СОБЫТИЯ
# Беру твой перечень событий. Если в "Новая таблица-11.xlsx" ты что-то добавила
# (например, новые UFC / старт РПЛ / Суперкубок) – просто допиши здесь новую строку.
EVENTS = [
    {"начало": "2025-03-26", "окончание": "2025-05-25", "название": "Плей-офф КХЛ", "вид спорта": "Хоккей"},
    {"начало": "2025-04-15", "окончание": "2025-06-22", "название": "Плей-офф НБА", "вид спорта": "Баскетбол"},
    {"начало": "2025-04-19", "окончание": "2025-06-23", "название": "Плей-офф НХЛ", "вид спорта": "Хоккей"},
    {"начало": "2025-04-26", "окончание": "2025-04-26", "название": "Эль Классико (апрель)", "вид спорта": "Футбол"},
    {"начало": "2025-05-09", "окончание": "2025-05-25", "название": "Чемпионат мира по хоккею", "вид спорта": "Хоккей"},
    {"начало": "2025-05-11", "окончание": "2025-05-11", "название": "Эль Классико (май)", "вид спорта": "Футбол"},
    {"начало": "2025-05-24", "окончание": "2025-05-24", "название": "Заключительный тур РПЛ", "вид спорта": "Футбол"},
    {"начало": "2025-05-25", "окончание": "2025-06-07", "название": "Теннис «Ролан Гаррос»", "вид спорта": "Теннис"},
    {"начало": "2025-05-31", "окончание": "2025-05-31", "название": "Финал Лиги чемпионов", "вид спорта": "Футбол"},
    {"начало": "2025-06-14", "окончание": "2025-07-13", "название": "Клубный чемпионат мира", "вид спорта": "Футбол"},
    {"начало": "2025-06-29", "окончание": "2025-06-29", "название": "UFC 317", "вид спорта": "UFC"},
    {"начало": "2025-06-30", "окончание": "2025-07-13", "название": "Теннис «Уимблдон»", "вид спорта": "Теннис"},
    {"начало": "2025-07-18", "окончание": "2025-10-29", "название": "Старт сезона РПЛ", "вид спорта": "Футбол"},
    {"начало": "2025-08-02", "окончание": "2025-10-29", "название": "Старт сезона АПЛ", "вид спорта": "Футбол"},
    {"начало": "2025-08-15", "окончание": "2025-10-29", "название": "Старт сезона Ла Лиги", "вид спорта": "Футбол"},
    {"начало": "2025-08-17", "окончание": "2025-08-17", "название": "UFC 319", "вид спорта": "UFC"},
    {"начало": "2025-08-25", "окончание": "2025-09-07", "название": "Теннис US Open", "вид спорта": "Теннис"},
    {"начало": "2025-08-27", "окончание": "2025-09-14", "название": "Баскетбол Евро-2025 (М)", "вид спорта": "Баскетбол"},
    {"начало": "2025-10-04", "окончание": "2025-10-04", "название": "UFC 320", "вид спорта": "UFC"},
    {"начало": "2025-10-07", "окончание": "2025-10-29", "название": "Старт сезона НХЛ", "вид спорта": "Хоккей"},
    {"начало": "2025-10-21", "окончание": "2025-10-29", "название": "Старт сезона НБА", "вид спорта": "Баскетбол"},
    {"начало": "2025-10-26", "окончание": "2025-10-26", "название": "Эль Классико (октябрь)", "вид спорта": "Футбол"},
]


df_events = pd.DataFrame(EVENTS)
df_events["начало"] = pd.to_datetime(df_events["начало"])
df_events["окончание"] = pd.to_datetime(df_events["окончание"])
df_events = df_events.sort_values("начало").reset_index(drop=True)

# =========================================================
# 2. ФИЛЬТР ПО ДАТАМ
# =========================================================
min_date = df_ctr["День"].min()
max_date = df_ctr["День"].max()

with st.sidebar:
    st.header("Фильтры")
    date_from, date_to = st.slider(
        "Диапазон дат",
        min_value=min_date.to_pydatetime(),
        max_value=max_date.to_pydatetime(),
        value=(min_date.to_pydatetime(), max_date.to_pydatetime()),
        format="DD.MM.YYYY",
    )

    top_n = st.number_input(
        "Пиков CTR вывести",
        min_value=3,
        max_value=30,
        value=8,
        step=1,
    )

date_from = pd.to_datetime(date_from)
date_to = pd.to_datetime(date_to)

df_view = df_ctr[(df_ctr["День"] >= date_from) & (df_ctr["День"] <= date_to)].copy()
df_view = df_view.dropna(subset=["CTR"])

# =========================================================
# 3. ЦВЕТА ПО ВИДАМ СПОРТА
# =========================================================
base_colors = [
    "rgba(46, 204, 113, 0.17)",  # зелёный
    "rgba(52, 152, 219, 0.17)",  # синий
    "rgba(231, 76, 60, 0.17)",   # красный
    "rgba(155, 89, 182, 0.17)",  # фиолет
    "rgba(241, 196, 15, 0.20)",  # жёлтый
    "rgba(230, 126, 34, 0.20)",  # оранж
]
sport_colors = {}
for i, sport in enumerate(df_events["вид спорта"].unique().tolist()):
    sport_colors[sport] = base_colors[i % len(base_colors)]

# =========================================================
# 4. ГРАФИК
# =========================================================
fig = go.Figure()

# линия CTR (в долях, но рисуем с форматированием в %)
fig.add_trace(
    go.Scatter(
        x=df_view["День"],
        y=df_view["CTR"],
        mode="lines+markers",
        name="CTR",
        line=dict(width=2.5),
        marker=dict(size=5),
        hovertemplate="%{x|%d.%m.%Y}<br>CTR: %{y:.2%}<extra></extra>",
    )
)

# события
for _, ev in df_events.iterrows():
    ev_start = ev["начало"]
    ev_end = ev["окончание"]
    sport = ev["вид спорта"]
    color = sport_colors.get(sport, "rgba(0,0,0,0.05)")

    # нет пересечения c выбранным диапазоном — пропускаем
    if ev_end < date_from or ev_start > date_to:
        continue

    x0 = max(ev_start, date_from)
    x1 = min(ev_end, date_to)

    fig.add_vrect(
        x0=x0,
        x1=x1,
        fillcolor=color,
        layer="below",
        line_width=0,
        annotation_text=ev["название"],
        annotation_position="top left",
        annotation=dict(
            font=dict(size=11, color="#ffffff"),
        ),
    )

    fig.add_vline(
        x=ev_start,
        line_width=1,
        line_dash="dash",
        line_color="rgba(0,0,0,0.35)",
    )
    if ev_end != ev_start:
        fig.add_vline(
            x=ev_end,
            line_width=1,
            line_dash="dash",
            line_color="rgba(0,0,0,0.2)",
        )

fig.update_layout(
    height=580,
    margin=dict(l=20, r=20, t=60, b=40),
    xaxis_title="Дата",
    yaxis_title="CTR",
    hovermode="x unified",
    legend=dict(
        orientation="h",
        yanchor="bottom",
        y=1.02,
        xanchor="right",
        x=1
    ),
)
fig.update_xaxes(showgrid=False, tickfont=dict(size=11))
fig.update_yaxes(showgrid=True, zeroline=False, tickformat=".2%")

st.plotly_chart(fig, use_container_width=True)

# =========================================================
# 5. ПИКОВЫЕ CTR
# =========================================================
# берём топ-N по CTR
peaks = df_view.sort_values("CTR", ascending=False).head(top_n).copy()

def date_in_events(d: pd.Timestamp) -> bool:
    for _, ev in df_events.iterrows():
        if ev["начало"] <= d <= ev["окончание"]:
            return True
    return False

def events_for_date(d: pd.Timestamp) -> str:
    names = []
    for _, ev in df_events.iterrows():
        if ev["начало"] <= d <= ev["окончание"]:
            names.append(ev["название"])
    return ", ".join(names)

peaks["В_событие"] = peaks["День"].apply(date_in_events)
peaks["Событие"] = peaks["День"].apply(events_for_date)
peaks["Дата"] = peaks["День"].dt.strftime("%d.%m.%Y")
peaks["CTR (в %)"] = peaks["CTR"].map(lambda x: f"{x:.2%}")

# порядок колонок
peaks_display = peaks[["Дата", "CTR (в %)", "Событие", "В_событие"]].copy()

st.subheader("Пиковые значения CTR")

def highlight_row(row):
    if row["В_событие"]:
        return ['background-color: rgba(231, 76, 60, 0.12)'] * len(row)
    return [''] * len(row)

st.dataframe(
    peaks_display.style.apply(highlight_row, axis=1),
    use_container_width=True,
    hide_index=True,
)


